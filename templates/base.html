<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Verzia{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --ig-bg: #000; 
            --ig-sidebar-bg: #000; 
            --ig-border: #262626; 
            --ig-text: #f5f5f5;
            --v-gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728);
            --modal-bg: #000;
            --input-bg: #111;
        }
        
        body.light-mode {
            --ig-bg: #ffffff;
            --ig-text: #1a1a1a;
            --ig-border: #efefef;
            --ig-sidebar-bg: #ffffff;
            --modal-bg: #ffffff;
            --input-bg: #f8f9fa;
        }

        body { 
            background: var(--ig-bg) !important; 
            color: var(--ig-text) !important; 
            margin: 0; 
            font-family: 'Montserrat', sans-serif; 
            overflow-x: hidden; 
            transition: background 0.4s ease, color 0.4s ease; 
        }

        .side-nav {
            width: 70px; 
            background-color: var(--ig-sidebar-bg) !important;
            border-right: 1px solid var(--ig-border) !important;
            display: flex; flex-direction: column; align-items: center;
            padding: 25px 0; position: fixed; height: 100vh; left: 0; top: 0; z-index: 999;
            justify-content: space-between;
        }

        .notif-wrapper { 
            position: relative; 
            cursor: pointer; 
            display: flex !important; 
            align-items: center; 
            justify-content: center; 
            width: 40px;
            height: 40px;
            margin: 5px 0;
        }

        #notifBell {
            font-size: 24px !important;
            color: #bf953f !important;
            display: inline-block !important;
            visibility: visible !important;
        }
        
        .notif-badge {
            position: absolute; top: 0; right: 0;
            background: var(--v-gold-gradient); color: #000;
            font-size: 10px; font-weight: bold; border-radius: 50%;
            width: 18px; height: 18px; display: flex !important; align-items: center; justify-content: center;
            border: 1px solid #000; z-index: 10;
        }
        
        .v-logo-nav {
            font-family: 'Playfair Display', serif;
            font-weight: 900; font-size: 32px;
            background: var(--v-gold-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-decoration: none; transition: 0.5s; cursor: pointer; display: inline-block;
        }

        .side-nav i, .side-nav a { 
            font-size: 24px; cursor: pointer; transition: 0.3s; text-decoration: none;
            background: var(--v-gold-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            display: inline-block !important;
        }
        
        .nav-top, .nav-bottom { display: flex; flex-direction: column; align-items: center; gap: 30px; }
        .main-content-wrapper { min-height: 100vh; transition: 0.3s; }
        .has-sidebar { margin-left: 70px; width: calc(100% - 70px); }

        /* --- ÇARPI BUTONU ÖZEL STİLİ --- */
        .btn-close-gold {
            background: none; border: none; 
            color: #bf953f !important; 
            font-size: 28px; font-weight: bold; 
            line-height: 1; cursor: pointer; 
            padding: 5px 10px; transition: 0.3s;
            position: absolute; top: 10px; right: 10px; z-index: 100;
        }
        .btn-close-gold:hover { transform: rotate(90deg) scale(1.2); filter: brightness(1.2); }

        .notif-item, .search-result-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 15px; border-bottom: 1px solid var(--ig-border);
            text-decoration: none; color: inherit;
        }
        .delete-notif-btn {
            background: none; border: none; color: #bf953f; cursor: pointer; padding: 5px; transition: 0.3s;
        }
        .delete-notif-btn:hover { color: #ff4d4d; }

        .search-input-gold {
            background: var(--input-bg) !important;
            border: 1px solid var(--ig-border) !important;
            color: var(--ig-text) !important;
            border-radius: 20px !important;
        }

        @media (max-width: 768px) {
            .side-nav { width: 100%; height: 60px; top: auto; bottom: 0; flex-direction: row; justify-content: space-around; padding: 0; }
            .has-sidebar { margin-left: 0; padding-bottom: 60px; width: 100%; }
        }
    </style>
</head>
<body class="{{ 'light-mode' if session.get('theme') == 'light' else '' }}">

    {% if current_user.is_authenticated and request.endpoint != 'index' %}
    <aside class="side-nav">
        <div class="nav-top">
            <a href="{{ url_for('index') }}" title="Ana Sayfa"><i class="fa-solid fa-house"></i></a>
            <i class="fa-solid fa-magnifying-glass" onclick="openSearchModal()"></i>
            <a href="{{ url_for('profile', username=current_user.username) }}" title="Profilim"><i class="fa-solid fa-user-circle"></i></a>
            
            <div class="notif-wrapper" onclick="openNotifModal()" title="Bildirimler">
                <i id="notifBell" class="fa-regular fa-bell {% if unread_notifications_count > 0 %}shake-active{% endif %}"></i>
                {% if unread_notifications_count > 0 %}
                <span id="notifBadge" class="notif-badge">{{ unread_notifications_count }}</span>
                {% endif %}
            </div>

            <a href="{{ url_for('profile', username='VERZİA') }}" class="v-logo-nav" title="Verzia Global">V</a>
        </div>
        <div class="nav-bottom">
            <a href="{{ url_for('settings') }}" title="Ayarlar"><i class="fa-solid fa-gear"></i></a>
            <a href="{{ url_for('logout') }}" title="Çıkış"><i class="fa-solid fa-right-from-bracket"></i></a>
        </div>
    </aside>
    {% endif %}

    <div class="main-content-wrapper {% if current_user.is_authenticated and request.endpoint != 'index' %}has-sidebar{% endif %}">
        {% block content %}{% endblock %}
    </div>

    <div class="modal fade" id="notifModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-md"> 
            <div class="modal-content" style="background-color: var(--modal-bg) !important; border: 1px solid #d4af37 !important; position: relative;">
                <button type="button" class="btn-close-gold" data-bs-dismiss="modal">×</button>
                <div class="modal-header border-0">
                    <h6 class="modal-title w-100 text-center fw-bold gold-title" style="color:#bf953f; padding-top: 10px;">BİLDİRİMLER</h6>
                </div>
                <div class="modal-body p-0" id="notifContainer" style="max-height: 400px; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: var(--modal-bg) !important; border: 1px solid #d4af37 !important; position: relative;">
                <button type="button" class="btn-close-gold" data-bs-dismiss="modal">×</button>
                <div class="modal-header border-0">
                    <h6 class="modal-title w-100 text-center fw-bold gold-title" style="color:#bf953f; padding-top: 10px;">KULLANICI ARA</h6>
                </div>
                <div class="modal-body p-4">
                    <input type="text" id="globalSearchInput" class="form-control search-input-gold" placeholder="Kullanıcı adı yazın..." oninput="executeGlobalSearch()">
                    <div id="globalSearchResults" class="mt-3" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editBioModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background-color: var(--modal-bg) !important; border: 1px solid #d4af37 !important; position: relative;">
                <button type="button" class="btn-close-gold" data-bs-dismiss="modal">×</button>
                <div class="modal-header border-bottom-0 p-3">
                    <h5 class="modal-title w-100 text-center" style="background: var(--v-gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; padding-top: 10px;">Biyografiyi Düzenle</h5>
                </div>
                <div class="modal-body p-4">
                    <form action="{{ url_for('update_bio') }}" method="POST">
                        <textarea name="bio" class="form-control mb-3" rows="4" style="background: var(--input-bg); border: 1px solid var(--ig-border); color: var(--ig-text);" placeholder="Kendinizden bahsedin...">{{ current_user.bio if current_user.is_authenticated else '' }}</textarea>
                        <button type="submit" class="btn w-100" style="background: var(--v-gold-gradient); color: #000; font-weight: bold; border: none; padding: 12px; border-radius: 8px;">Kaydet</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function openSearchModal() { new bootstrap.Modal(document.getElementById('searchModal')).show(); setTimeout(() => document.getElementById('globalSearchInput').focus(), 500); }
        async function executeGlobalSearch() {
            const q = document.getElementById('globalSearchInput').value;
            const resDiv = document.getElementById('globalSearchResults');
            if (q.length < 2) { resDiv.innerHTML = ''; return; }
            try {
                const response = await fetch(`/search_users?q=${encodeURIComponent(q)}`);
                const users = await response.json();
                resDiv.innerHTML = users.map(u => `<a href="/profile/${u.username}" class="search-result-item"><div style="display:flex; align-items:center; gap:12px;"><img src="${u.avatar}" style="width:35px; height:35px; border-radius:50%; border:1px solid #d4af37; object-fit: cover;"><span>${u.username}</span></div><i class="fa-solid fa-chevron-right" style="font-size: 12px; opacity:0.5;"></i></a>`).join('');
            } catch (e) { console.error(e); }
        }

        async function openNotifModal() {
            const container = document.getElementById('notifContainer');
            container.innerHTML = '<p class="text-center p-3 opacity-50">Yükleniyor...</p>';
            new bootstrap.Modal(document.getElementById('notifModal')).show();
            try {
                const response = await fetch('/notifications');
                const data = await response.json();
                if (data.length === 0) { container.innerHTML = '<p class="text-center p-3 opacity-50">Yeni bildirim yok.</p>'; }
                else {
                    container.innerHTML = data.map(n => `<div class="notif-item" id="notif-${n.id}"><div style="font-size: 0.85rem; flex: 1; padding-right: 10px;"><a href="/profile/${n.sender}" style="color: #bf953f; font-weight: bold; text-decoration: none;">@${n.sender}</a> ${n.message.split(n.sender)[1] || n.message}<div style="font-size: 0.7rem; opacity: 0.4;">${n.timestamp}</div></div><button class="delete-notif-btn" onclick="deleteNotif(${n.id})"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`).join('');
                    document.getElementById('notifBell').classList.remove('shake-active');
                    if(document.getElementById('notifBadge')) document.getElementById('notifBadge').style.display = 'none';
                }
            } catch (e) { container.innerHTML = '<p class="text-center p-3 text-danger">Hata!</p>'; }
        }

        async function deleteNotif(notifId) {
            try {
                const response = await fetch(`/delete_notification/${notifId}`, { method: 'POST' });
                const data = await response.json();
                if (data.status === "success") {
                    const el = document.getElementById(`notif-${notifId}`);
                    if (el) { el.style.opacity = '0'; el.style.transform = 'translateX(20px)'; el.style.transition = '0.3s'; setTimeout(() => el.remove(), 300); }
                }
            } catch (e) { console.error(e); }
        }

        function openEditBioModal() { new bootstrap.Modal(document.getElementById('editBioModal')).show(); }

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') document.body.classList.add('light-mode');
        }
        applyInitialTheme();
    </script>
</body>
</html>