<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Verzia{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --ig-bg: #000; 
            --ig-sidebar-bg: #000; 
            --ig-border: #262626; 
            --ig-text: #f5f5f5;
            --v-gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728);
            --modal-bg: #000;
            --input-bg: #111;
        }
        
        body.light-mode {
            --ig-bg: #ffffff;
            --ig-text: #1a1a1a;
            --ig-border: #efefef;
            --ig-sidebar-bg: #ffffff;
            --modal-bg: #ffffff;
            --input-bg: #f8f9fa;
        }

        body { 
            background: var(--ig-bg) !important; 
            color: var(--ig-text) !important; 
            margin: 0; 
            font-family: 'Montserrat', sans-serif; 
            overflow-x: hidden; 
            transition: background 0.4s ease, color 0.4s ease; 
        }

        .side-nav {
            width: 70px; 
            background-color: var(--ig-sidebar-bg) !important;
            border-right: 1px solid var(--ig-border) !important;
            display: flex; flex-direction: column; align-items: center;
            padding: 25px 0; position: fixed; height: 100vh; left: 0; top: 0; z-index: 999;
            justify-content: space-between;
        }

        /* --- BİLDİRİM ZİLİ KESİN GÖRÜNÜRLÜK AYARI --- */
        .notif-wrapper { 
            position: relative; 
            cursor: pointer; 
            display: flex !important; 
            align-items: center; 
            justify-content: center; 
            width: 40px;
            height: 40px;
            margin: 5px 0;
        }

        #notifBell {
            font-size: 24px !important;
            color: #bf953f !important; /* Altın sarısı zorunlu renk */
            display: inline-block !important;
            visibility: visible !important;
        }
        
        .notif-badge {
            position: absolute; top: 0; right: 0;
            background: var(--v-gold-gradient); color: #000;
            font-size: 10px; font-weight: bold; border-radius: 50%;
            width: 18px; height: 18px; display: flex !important; align-items: center; justify-content: center;
            border: 1px solid #000; z-index: 10;
        }
        
        .shake-active { animation: bellShake 2s infinite !important; }
        @keyframes bellShake {
            0% { transform: rotate(0); }
            15% { transform: rotate(15deg); }
            30% { transform: rotate(-15deg); }
            45% { transform: rotate(10deg); }
            60% { transform: rotate(-10deg); }
            100% { transform: rotate(0); }
        }

        .v-logo-nav {
            font-family: 'Playfair Display', serif;
            font-weight: 900; font-size: 32px; font-style: italic;
            background: var(--v-gold-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-decoration: none; transition: 0.5s; cursor: pointer; display: inline-block;
            animation: goldPulse 3s infinite ease-in-out;
        }

        .side-nav i, .side-nav a { 
            font-size: 24px; cursor: pointer; transition: 0.3s; text-decoration: none;
            background: var(--v-gold-gradient);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            display: inline-block !important;
        }
        
        .nav-top, .nav-bottom { display: flex; flex-direction: column; align-items: center; gap: 30px; }
        .main-content-wrapper { min-height: 100vh; transition: 0.3s; }
        .has-sidebar { margin-left: 70px; width: calc(100% - 70px); }

        @media (max-width: 768px) {
            .side-nav { width: 100%; height: 60px; top: auto; bottom: 0; flex-direction: row; justify-content: space-around; padding: 0; }
            .has-sidebar { margin-left: 0; padding-bottom: 60px; width: 100%; }
        }
        
        /* BİLDİRİM İÇİ EKSTRA STİLLER */
        .notif-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 15px; border-bottom: 1px solid var(--ig-border);
        }
        .delete-notif-btn {
            background: none; border: none; color: #bf953f; cursor: pointer; padding: 5px; opacity: 0.7; transition: 0.3s;
        }
        .delete-notif-btn:hover { opacity: 1; color: #ff4d4d; transform: scale(1.1); }
    </style>
</head>
<body class="{{ 'light-mode' if session.get('theme') == 'light' else '' }}">

    {% if current_user.is_authenticated and request.endpoint != 'index' %}
    <aside class="side-nav">
        <div class="nav-top">
            <a href="{{ url_for('index') }}" title="Ana Sayfa"><i class="fa-solid fa-house"></i></a>
            <i class="fa-solid fa-magnifying-glass" onclick="openSearchModal()"></i>
            <a href="{{ url_for('profile', username=current_user.username) }}" title="Profilim"><i class="fa-solid fa-user-circle"></i></a>
            
            <div class="notif-wrapper" onclick="openNotifModal()" title="Bildirimler">
                <i id="notifBell" class="fa-regular fa-bell {% if unread_notifications_count > 0 %}shake-active{% endif %}"></i>
                {% if unread_notifications_count > 0 %}
                <span id="notifBadge" class="notif-badge">{{ unread_notifications_count }}</span>
                {% endif %}
            </div>

            <a href="{{ url_for('profile', username='VERZİA') }}" class="v-logo-nav" title="Verzia Global">V</a>
        </div>
        <div class="nav-bottom">
            <a href="{{ url_for('settings') }}" title="Ayarlar"><i class="fa-solid fa-gear"></i></a>
            <a href="{{ url_for('logout') }}" title="Çıkış"><i class="fa-solid fa-right-from-bracket"></i></a>
        </div>
    </aside>
    {% endif %}

    <div class="main-content-wrapper {% if current_user.is_authenticated and request.endpoint != 'index' %}has-sidebar{% endif %}">
        {% block content %}{% endblock %}
    </div>

    <div class="modal fade" id="notifModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-md"> <div class="modal-content" style="background-color: var(--modal-bg) !important; border: 1px solid #d4af37 !important;">
                <div class="modal-header border-0">
                    <h6 class="modal-title w-100 text-center fw-bold gold-title">BİLDİRİMLER</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body p-0" id="notifContainer" style="max-height: 400px; overflow-y: auto;">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function openNotifModal() {
            const container = document.getElementById('notifContainer');
            const bell = document.getElementById('notifBell');
            const badge = document.getElementById('notifBadge');
            
            container.innerHTML = '<p class="text-center p-3 opacity-50">Yükleniyor...</p>';
            new bootstrap.Modal(document.getElementById('notifModal')).show();

            try {
                const response = await fetch('/notifications');
                const data = await response.json();
                
                if (data.length === 0) {
                    container.innerHTML = '<p class="text-center p-3 opacity-50">Yeni bildirim yok.</p>';
                } else {
                    container.innerHTML = data.map(n => `
                        <div class="notif-item" id="notif-${n.id}">
                            <div style="font-size: 0.85rem; flex: 1; padding-right: 10px;">
                                <a href="/profile/${n.sender}" style="color: #bf953f; font-weight: bold; text-decoration: none;">@${n.sender}</a> 
                                ${n.message.split(n.sender)[1] || n.message}
                                <div style="font-size: 0.7rem; opacity: 0.4;">${n.timestamp}</div>
                            </div>
                            <button class="delete-notif-btn" onclick="deleteNotif(${n.id})">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                            </button>
                        </div>
                    `).join('');
                    
                    if(bell) bell.classList.remove('shake-active');
                    if(badge) badge.style.display = 'none';
                }
            } catch (e) { container.innerHTML = '<p class="text-center p-3 text-danger">Hata!</p>'; }
        }

        async function deleteNotif(notifId) {
            try {
                const response = await fetch(`/delete_notification/${notifId}`, { method: 'POST' });
                const data = await response.json();
                if (data.status === "success") {
                    const el = document.getElementById(`notif-${notifId}`);
                    if (el) {
                        el.style.opacity = '0';
                        el.style.transform = 'translateX(20px)';
                        el.style.transition = '0.3s';
                        setTimeout(() => el.remove(), 300);
                    }
                }
            } catch (e) { console.error("Silme hatası:", e); }
        }

        function applyInitialTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'light') document.body.classList.add('light-mode');
        }
        applyInitialTheme();
    </script>
</body>
</html>