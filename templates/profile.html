{% extends "base.html" %}

{% block title %}Profil - {{ username if username else 'Kullanıcı' }}{% endblock %}

{% block head %}
    <style>
        /* Profile page styles - modern Pinterest/TikTok mix */
        .profile-hero{background: linear-gradient(90deg,#f6f9ff,#eef6f3);padding:40px 0;border-radius:8px}
        .profile-card{background:white;border-radius:12px;padding:24px;box-shadow:0 6px 18px rgba(20,30,40,0.08)}
        .profile-avatar{width:120px;height:120px;border-radius:50%;object-fit:cover;border:6px solid rgba(255,255,255,0.9);box-shadow:0 6px 18px rgba(20,30,40,0.08)}
        .profile-name{font-size:1.35rem;font-weight:700;margin-bottom:6px}
        .profile-handle{color:#6b7280;margin-bottom:10px}
        .profile-bio{color:#374151;margin-bottom:14px}
        .profile-stats{display:flex;gap:18px}
        .profile-stats .stat{font-weight:700;text-align:center}

        /* Tabs */
        .tabs{display:flex;gap:8px;border-bottom:1px solid #e6e9ee;margin-top:18px}
        .tab{padding:10px 14px;border-radius:8px 8px 0 0;background:transparent;color:#374151;cursor:pointer}
        .tab.active{background:white;box-shadow:0 -1px 0 rgba(0,0,0,0.03);border-bottom:2px solid #fff}

        /* Masonry grid (Pinterest-like) */
        .masonry{column-gap:16px}
        .masonry .card{display:inline-block;width:100%;margin:0 0 16px;border-radius:12px;overflow:hidden;background:white;box-shadow:0 6px 18px rgba(20,30,40,0.06);transition:transform .25s ease,box-shadow .25s ease}
        .masonry .card img{width:100%;height:auto;display:block}
        .masonry .card:hover{transform:translateY(-6px) scale(1.01);box-shadow:0 12px 30px rgba(20,30,40,0.12)}
        .card .desc{padding:10px 12px;color:#374151;font-size:0.95rem}

        /* Reposts list (TikTok-like) */
        .reposts .repost{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;background:white;box-shadow:0 6px 18px rgba(20,30,40,0.04);margin-bottom:12px;transition:box-shadow .18s ease}
        .reposts .repost:hover{box-shadow:0 14px 34px rgba(20,30,40,0.12)}
        .repost .mini-avatar{width:44px;height:44px;border-radius:50%;object-fit:cover}
        .repost .meta{flex:1}
        .repost .meta .user{font-weight:700}
        .repost .meta .time{color:#6b7280;font-size:0.85rem}
        .repost .thumb{width:84px;height:64px;object-fit:cover;border-radius:8px}

        /* Responsive columns */
        @media (max-width:599px){.masonry{column-count:2;padding:8px}} 
        @media (min-width:600px) and (max-width:899px){.masonry{column-count:3;padding:12px}} 
        @media (min-width:900px){.masonry{column-count:4;padding:16px}}

        /* Offcanvas tweaks if needed */
        #authOffcanvas .offcanvas-body{padding-top:0}

        /* Small helpers */
        .muted{color:#6b7280}
    </style>
{% endblock %}

{% block content %}
<div class="profile-hero">
    <div class="container">
        <div class="profile-card d-flex gap-4 align-items-center">
            <img class="profile-avatar" src="https://picsum.photos/seed/profile/400/400" alt="avatar">
            <div style="flex:1;min-width:0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div id="profileName" class="profile-name">Cemre ÖZTÜRK</div>
                            <div id="profileHandle" class="profile-handle">@cemre_online</div>
                            <div id="profileBio" class="profile-bio">Fotoğrafçı • Seyahat tutkunu • Günlük kısa notlar ve ilham verici kareler.</div>
                        </div>
                        <div class="text-end profile-actions">
                            <button id="followBtn" class="btn btn-outline-primary">Takip Et</button>
                            <button id="editProfileBtn" class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#editProfileModal" style="display:none">Profili Düzenle</button>
                        </div>
                    </div>

                <div class="profile-stats mt-3">
                            <div class="stat"><div class="muted">Takipçi</div><div id="followerCount">12.3K</div></div>
                            <div class="stat"><div class="muted">Takip</div><div id="followingCount">420</div></div>
                            <div class="stat"><div class="muted">Paylaşım</div><div id="postCount">187</div></div>
                        </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="profile-card">
        <div class="d-flex justify-content-between align-items-center">
            <div class="tabs" role="tablist">
                <div class="tab active" data-tab="pins">Pinler / Gönderiler</div>
                <div class="tab" data-tab="reposts">Repostlar / Tekrar Paylaşımlar</div>
            </div>
            <div class="muted small">Sırala: <select class="form-select form-select-sm d-inline-block" style="width:auto;margin-left:8px"><option>Yeni</option><option>Popüler</option></select></div>
        </div>

        <!-- Pins -->
        <div id="pins" class="tab-panel mt-3">
            <div class="masonry" id="masonry">
                <!-- cards generated by JS -->
            </div>
        </div>

        <!-- Reposts -->
        <div id="reposts" class="tab-panel mt-3" style="display:none">
            <div class="reposts" id="reposts-list">
                <!-- repost items generated by JS -->
            </div>
        </div>
    </div>
</div>

<script>
    // Tabs behavior
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',e=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        e.currentTarget.classList.add('active');
        const tab = e.currentTarget.dataset.tab;
        document.querySelectorAll('.tab-panel').forEach(p=>p.style.display = 'none');
        document.getElementById(tab).style.display = '';
    }));

    // Sample data and rendering
    const pinsData = [];
    for(let i=1;i<=12;i++){
        const w = 400; const h = 220 + Math.floor(Math.random()*260);
        pinsData.push({id:i,src:`https://picsum.photos/seed/p${i}/${w}/${h}`,desc:`Güzel bir kare #${i}`});
    }

    const masonry = document.getElementById('masonry');
    pinsData.forEach(p=>{
        const card = document.createElement('div'); card.className='card';
        card.innerHTML = `<img src="${p.src}" alt="img"><div class=\"desc\">${p.desc}</div>`;
        masonry.appendChild(card);
    });

    // Reposts sample
    const reposts = [];
    for(let i=1;i<=8;i++){ reposts.push({id:i,user:`user${i}`,avatar:`https://i.pravatar.cc/150?img=${10+i}`,text:`Bu tekrar paylaşımın kısa açıklaması ${i}`,time:`${i+1} gün önce`,thumb: i%2?`https://picsum.photos/seed/r${i}/200/140`:null}); }
    const repostsList = document.getElementById('reposts-list');
    reposts.forEach(r=>{
        const el = document.createElement('div'); el.className='repost';
        el.innerHTML = `<img class=\"mini-avatar\" src=\"${r.avatar}\"><div class=\"meta\"><div class=\"user\">${r.user}</div><div class=\"time\">${r.time}</div><div class=\"text\">${r.text}</div></div>${r.thumb?`<img class=\"thumb\" src=\"${r.thumb}\">`:''}`;
        repostsList.appendChild(el);
    });

    // Ensure images load for masonry columns (optional: could use imagesLoaded lib)
    window.addEventListener('load',()=>{ /* nothing extra needed for CSS column masonry */ });
</script>
<!-- Edit profile modal and localStorage-based personalization -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileLabel">Profili Düzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="mb-2">
                        <label class="form-label">Görünen ad</label>
                        <input id="editName" class="form-control" type="text">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Kullanıcı etiketi (handle)</label>
                        <input id="editHandle" class="form-control" type="text">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Avatar URL</label>
                        <input id="editAvatar" class="form-control" type="text" placeholder="https://...">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Biyografi</label>
                        <textarea id="editBio" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="row gx-2">
                        <div class="col">
                            <label class="form-label">Takipçi</label>
                            <input id="editFollowers" class="form-control" type="text">
                        </div>
                        <div class="col">
                            <label class="form-label">Takip</label>
                            <input id="editFollowing" class="form-control" type="text">
                        </div>
                        <div class="col">
                            <label class="form-label">Paylaşım</label>
                            <input id="editPosts" class="form-control" type="text">
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <button type="button" id="saveProfileBtn" class="btn btn-success">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
        const viewedUsername = "{{ username|e }}";
        const serverProfile = {% if server_profile %}{{ server_profile|tojson|safe }}{% else %}null{% endif %};
        const canEdit = {% if can_edit %}true{% else %}false{% endif %};
        const editBtn = document.getElementById('editProfileBtn');
        const avatarEl = document.querySelector('.profile-avatar');
        const nameEl = document.getElementById('profileName');
        const handleEl = document.getElementById('profileHandle');
        const bioEl = document.getElementById('profileBio');
        const followerEl = document.getElementById('followerCount');
        const followingEl = document.getElementById('followingCount');
        const postEl = document.getElementById('postCount');

        function storageKey(user){ return 'profile::' + user; }

        function loadProfile(user){
            if(!user) return;
            // Prefer server-side profile if available
            if(serverProfile && serverProfile.username && serverProfile.username === user){
                if(serverProfile.avatar) avatarEl.src = serverProfile.avatar;
                if(serverProfile.name) nameEl.textContent = serverProfile.name;
                if(serverProfile.handle) handleEl.textContent = serverProfile.handle;
                if(serverProfile.bio) bioEl.textContent = serverProfile.bio;
                if(serverProfile.followers) followerEl.textContent = serverProfile.followers;
                if(serverProfile.following) followingEl.textContent = serverProfile.following;
                if(serverProfile.posts) postEl.textContent = serverProfile.posts;
                return;
            }
            const raw = localStorage.getItem(storageKey(user));
            if(raw){
                try{
                    const data = JSON.parse(raw);
                    if(data.avatar) avatarEl.src = data.avatar;
                    if(data.name) nameEl.textContent = data.name;
                    if(data.handle) handleEl.textContent = data.handle;
                    if(data.bio) bioEl.textContent = data.bio;
                    if(data.followers) followerEl.textContent = data.followers;
                    if(data.following) followingEl.textContent = data.following;
                    if(data.posts) postEl.textContent = data.posts;
                }catch(e){console.error(e)}
            }
        }

        function openEdit(){
            if(!viewedUsername){
                alert('Önce bir kullanıcı adı girip profili açmalısın.');
                return;
            }
            // If server profile and editable, populate from server
            if(serverProfile && serverProfile.username === viewedUsername){
                document.getElementById('editName').value = serverProfile.name || nameEl.textContent || '';
                document.getElementById('editHandle').value = serverProfile.handle || handleEl.textContent || '';
                document.getElementById('editAvatar').value = serverProfile.avatar || avatarEl.src || '';
                document.getElementById('editBio').value = serverProfile.bio || bioEl.textContent || '';
                document.getElementById('editFollowers').value = serverProfile.followers || followerEl.textContent || '';
                document.getElementById('editFollowing').value = serverProfile.following || followingEl.textContent || '';
                document.getElementById('editPosts').value = serverProfile.posts || postEl.textContent || '';
                return;
            }
            // populate fields from localStorage fallback
            const raw = localStorage.getItem(storageKey(viewedUsername));
            const d = raw ? JSON.parse(raw) : {};
            document.getElementById('editName').value = d.name || nameEl.textContent || '';
            document.getElementById('editHandle').value = d.handle || handleEl.textContent || '';
            document.getElementById('editAvatar').value = d.avatar || avatarEl.src || '';
            document.getElementById('editBio').value = d.bio || bioEl.textContent || '';
            document.getElementById('editFollowers').value = d.followers || followerEl.textContent || '';
            document.getElementById('editFollowing').value = d.following || followingEl.textContent || '';
            document.getElementById('editPosts').value = d.posts || postEl.textContent || '';
        }

        function saveProfile(){
            const payload = {
                name: document.getElementById('editName').value.trim(),
                handle: document.getElementById('editHandle').value.trim(),
                avatar: document.getElementById('editAvatar').value.trim(),
                bio: document.getElementById('editBio').value.trim(),
                followers: document.getElementById('editFollowers').value.trim(),
                following: document.getElementById('editFollowing').value.trim(),
                posts: document.getElementById('editPosts').value.trim()
            };
            // If serverProfile and editing is allowed, save to server
            if(serverProfile && canEdit){
                fetch('/profile/save', {method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams(payload)})
                    .then(r=>r.json()).then(j=>{
                        // on success, reload from server
                        loadProfile(viewedUsername);
                        try{ const modalEl = document.getElementById('editProfileModal'); const m = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl); m.hide(); }catch(e){}
                    }).catch(e=>console.error(e));
                return;
            }
            localStorage.setItem(storageKey(viewedUsername), JSON.stringify(payload));
            // apply
            loadProfile(viewedUsername);
            // close modal
            try{ const modalEl = document.getElementById('editProfileModal'); const m = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl); m.hide(); }catch(e){}
        }

        // If a username is present, show edit button (only if allowed) and load saved profile
        if(viewedUsername && viewedUsername.length>0){
            editBtn.style.display = canEdit ? '' : 'none';
            loadProfile(viewedUsername);
            if(canEdit){
                editBtn.addEventListener('click', openEdit);
                document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            }
        } else {
            // no username -> inform user to open a profile via lookup
            editBtn.style.display = 'none';
        }
    })();
</script>
{% endblock %}