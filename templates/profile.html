{% extends "base.html" %}

{% block content %}
<style>
/* --- MEVCUT TASARIMIN (DOKUNULMADI) --- */
.ig-container { 
    width: 100%; 
    max-width: 935px; 
    margin: 0 auto; 
    padding: 30px 20px; 
    color: var(--ig-text); 
    font-family: 'Montserrat', sans-serif; 
}
.ig-header { display: flex; margin-bottom: 44px; align-items: center; border-bottom: 1px solid var(--ig-border); padding-bottom: 40px; }
.ig-avatar-area { flex: 1; display: flex; justify(center); position: relative; }
.avatar-wrapper { position: relative; cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.avatar-wrapper:hover { transform: scale(1.05); }
.profile-avatar { width: 150px !important; height: 150px !important; border-radius: 50% !important; object-fit: cover; border: 1px solid var(--ig-border); padding: 5px; background-color: var(--ig-bg); }
.ig-info-area { flex: 2; padding-left: 30px; }
.ig-user-row { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.profile-name { font-size: 28px; font-weight: 300; margin: 0; color: var(--ig-text); text-transform: uppercase; }

/* VERZIA GOLD DETAYLAR */
.verzia-gold-text { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; }
.gold-verify { font-size: 20px; background: linear-gradient(135deg, #a67c00 0%, #ffbf00 50%, #b8860b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0px 1px 1px rgba(0,0,0,0.3)); }
body:not(.light-mode) .gold-verify { background: linear-gradient(135deg, #d4af37 0%, #fff9e3 50%, #c5a028 100%); -webkit-background-clip: text; }

/* BUTONLAR - GOLD GRADIENT */
.btn-ig-edit, .btn-ig-follow { 
    background: transparent !important; 
    border: 1px solid #bf953f !important; 
    border-radius: 4px !important; 
    background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    font-weight: 700; 
    font-size: 14px; 
    padding: 5px 12px; 
    cursor: pointer; 
    transition: all 0.3s ease;
    display: inline-block;
}
.btn-ig-edit:hover, .btn-ig-follow:hover {
    filter: drop-shadow(0 0 5px rgba(252, 246, 186, 0.4));
    border-color: #fcf6ba !important;
    transform: scale(1.02);
}

.verzia-gold-btn { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728) !important; color: #000 !important; font-weight: bold; border: none !important; padding: 8px 20px; border-radius: 5px; cursor: pointer; transition: transform 0.2s; }
.verzia-gold-btn:hover { transform: scale(1.05); }

/* Ä°STATÄ°STÄ°KLER */
.ig-stats { display: flex; gap: 40px; list-style: none; padding: 0; margin-bottom: 20px; }
.ig-stats li { font-size: 16px; color: var(--ig-text); }
.ig-stats b { font-weight: 600; }
.ig-bio { font-size: 16px; line-height: 1.5; color: var(--ig-text); }

/* GALERÄ° */
.ig-photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 28px; margin-top: 10px; }
.grid-item { aspect-ratio: 1/1; overflow: hidden; background: var(--ig-border); position: relative; border-radius: 4px; }
.grid-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; cursor: pointer; }

/* SOL BAR TASARIMI */
.side-nav {
    width: 70px; 
    background-color: var(--ig-sidebar-bg); 
    border-right: 1px solid var(--ig-border);
    display: flex; 
    flex-direction: column; 
    align-items: center;
    padding: 25px 0; 
    position: fixed; 
    height: 100vh; 
    left: 0; 
    top: 0; 
    z-index: 999;
    justify-content: space-between; 
}

.nav-top, .nav-bottom { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    gap: 35px !important; 
}

/* MODAL GÃœNCELLEMELERÄ° */
.v-modal-content { background-color: #000 !important; border: 1px solid #d4af37 !important; color: var(--ig-text) !important; border-radius: 12px; }
.btn-close-left { background: none; border: none; color: #bf953f; font-size: 24px; cursor: pointer; padding: 0; margin-right: 15px; }
.notif-item { display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid #262626; }

#avatarInput, #photoUploadInput { display: none; }
</style>

<aside class="side-nav">
    <div class="nav-top">
        <a href="{{ url_for('index') }}" title="Ana Sayfa"><i class="fa-solid fa-house"></i></a>
        <i class="fa-solid fa-magnifying-glass" onclick="openSearchModal()" title="KullanÄ±cÄ± Ara"></i>
        <a href="{{ url_for('profile', username=current_user.username) }}" title="Profilim"><i class="fa-solid fa-user-circle active"></i></a>
        
        <div class="notif-wrapper" onclick="openNotifModal()" title="Bildirimler">
            <i id="notifBell" class="fa-solid fa-bell {% if unread_notifications_count > 0 %}shake-active{% endif %}"></i>
            {% if unread_notifications_count > 0 %}
            <span id="notifBadge" class="notif-badge">{{ unread_notifications_count }}</span>
            {% endif %}
        </div>

        <a href="{{ url_for('profile', username='VERZÄ°A') }}" class="v-logo-nav" title="Verzia Global">V</a>
    </div>
    <div class="nav-bottom">
        <a href="{{ url_for('settings') }}" title="Ayarlar"><i class="fa-solid fa-gear"></i></a>
        <a href="{{ url_for('logout') }}" title="Ã‡Ä±kÄ±ÅŸ"><i class="fa-solid fa-right-from-bracket"></i></a>
    </div>
</aside>

<div class="ig-container" style="padding-left: 90px;"> 
    <header class="ig-header">
        <div class="ig-avatar-area">
            <div class="avatar-wrapper" {% if can_edit %}onclick="document.getElementById('avatarInput').click()"{% endif %}>
                <img class="profile-avatar" id="avatarPreview" src="{{ server_profile.avatar }}" alt="avatar">
                {% if can_edit %}<input type="file" id="avatarInput" accept="image/*" onchange="previewImage(event)">{% endif %}
            </div>
        </div>
        <div class="ig-info-area">
            <div class="ig-user-row">
                <h2 class="profile-name">{{ server_profile.username }}</h2>
                {% if server_profile.is_vip %}<i class="fa-solid fa-circle-check gold-verify"></i>{% endif %}
                
                {% if can_edit %}
                <button class="btn-ig-edit" onclick="openEditBioModal()">Profili DÃ¼zenle</button>
                {% else %}
                <button class="btn-ig-follow" id="followBtn" onclick="toggleFollow('{{ server_profile.username }}')">
                    {% if is_following %}Takibi BÄ±rak{% else %}Takip Et{% endif %}
                </button>
                {% endif %}
            </div>
            <ul class="ig-stats">
                <li><b>{{ photos|length }}</b> gÃ¶nderi</li>
                <li onclick="{% if not server_profile.is_kurucu %}showUserList('followers'){% else %}void(0){% endif %}" style="{% if not server_profile.is_kurucu %}cursor:pointer{% endif %}">
                    <b id="followerCount">{{ server_profile.followers }}</b> takipÃ§i
                </li>
                <li onclick="showUserList('following')" style="cursor:pointer">
                    <b>{{ server_profile.following }}</b> takip
                </li>
            </ul>
            <div class="ig-bio">
                <p class="mt-1" style="white-space: pre-wrap;">{{ server_profile.bio }}</p>
            </div>
        </div>
    </header>

    <div class="ig-photo-grid">
        {% if photos %}
            {% for photo in photos %}
            <div class="grid-item">
                <img src="{{ url_for('uploaded_file', filename=photo.filename) }}" alt="{{ photo.title }}">
            </div>
            {% endfor %}
        {% else %}
            <div class="no-posts" style="grid-column: 1/-1; text-align: center; padding: 80px 20px; border: 1px dashed #bf953f; border-radius: 12px; background: rgba(191,149,63,0.03);">
                <div style="font-size: 50px; margin-bottom: 15px;">ðŸ“¸</div>
                <h3 class="verzia-gold-text">HenÃ¼z hiÃ§ gÃ¶nderi yok</h3>
                <p style="opacity: 0.7; margin-bottom: 20px;">Sen de hemen ÅŸimdi ilk fotoÄŸrafÄ±nÄ± paylaÅŸ!</p>
                {% if can_edit %}
                <button class="verzia-gold-btn" onclick="document.getElementById('photoUploadInput').click()">Hemen PaylaÅŸ</button>
                <form id="directUploadForm" action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data" style="display:none;">
                    <input type="file" name="photo" id="photoUploadInput" onchange="this.form.submit()">
                </form>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="notifModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content v-modal-content">
            <div class="modal-header border-0 d-flex align-items-center p-3">
                <button type="button" class="btn-close-left" data-bs-dismiss="modal">Ã—</button>
                <h5 class="modal-title verzia-gold-text m-0">BÄ°LDÄ°RÄ°MLER</h5>
            </div>
            <div class="modal-body p-0" id="notifContainer" style="max-height: 450px; overflow-y: auto;">
                <p class="text-center p-4 opacity-50">YÃ¼kleniyor...</p>
            </div>
        </div>
    </div>
</div>

<div class="modal fade v-modal-list" id="userListModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content v-modal-content">
            <div class="modal-header border-0">
                <h6 class="modal-title w-100 text-center fw-bold gold-title" id="userListTitle">Liste</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" style="filter: invert(1);"></button>
            </div>
            <div class="modal-body p-0" id="userListContainer"></div>
        </div>
    </div>
</div>

<script>
// BÄ°LDÄ°RÄ°M FONKSÄ°YONLARI - KESÄ°N Ã‡Ã–ZÃœM
async function openNotifModal() {
    const container = document.getElementById('notifContainer');
    const bell = document.getElementById('notifBell');
    const badge = document.getElementById('notifBadge');
    
    container.innerHTML = '<p class="text-center p-4 opacity-50">YÃ¼kleniyor...</p>';
    new bootstrap.Modal(document.getElementById('notifModal')).show();

    try {
        const response = await fetch('/notifications');
        const data = await response.json();
        
        if (data.length === 0) {
            container.innerHTML = '<p class="text-center p-4 opacity-50">HenÃ¼z bildirim yok.</p>';
        } else {
            container.innerHTML = data.map(n => `
                <div class="notif-item" id="notif-${n.id}">
                    <div style="flex: 1; padding-right: 15px;">
                        <a href="/profile/${n.sender}" style="color: #bf953f; font-weight: bold; text-decoration: none;">@${n.sender}</a> 
                        <span style="color: #f5f5f5;">${n.message.split(n.sender)[1] || n.message}</span>
                        <div style="font-size: 0.7rem; opacity: 0.5; margin-top: 4px;">${n.timestamp}</div>
                    </div>
                    <button onclick="deleteNotif(${n.id})" style="background:none; border:none; cursor:pointer; color:#bf953f; display:flex; align-items:center;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    </button>
                </div>
            `).join('');
            
            if(bell) bell.classList.remove('shake-active');
            if(badge) badge.style.display = 'none';
        }
    } catch (e) { container.innerHTML = '<p class="text-center p-4 text-danger">Hata oluÅŸtu.</p>'; }
}

async function deleteNotif(notifId) {
    try {
        const response = await fetch(`/delete_notification/${notifId}`, { method: 'POST' });
        const data = await response.json();
        if (data.status === "success") {
            const el = document.getElementById(`notif-${notifId}`);
            if (el) {
                el.style.opacity = '0';
                el.style.transform = 'translateX(20px)';
                el.style.transition = '0.3s';
                setTimeout(() => el.remove(), 300);
            }
        }
    } catch (e) { console.error("Silme hatasÄ±:", e); }
}

async function showUserList(type) {
    const pathArray = window.location.pathname.split('/');
    const username = pathArray[pathArray.length - 1];
    const container = document.getElementById('userListContainer');
    const title = document.getElementById('userListTitle');
    title.innerText = type === 'followers' ? 'TakipÃ§iler' : 'Takip Edilenler';
    new bootstrap.Modal(document.getElementById('userListModal')).show();
    try {
        const response = await fetch(`/get_user_list/${username}/${type}`);
        const users = await response.json();
        container.innerHTML = users.map(u => `
            <a href="/profile/${u.username}" style="display:flex;align-items:center;padding:12px;text-decoration:none;color:inherit;border-bottom:1px solid var(--ig-border);">
                <img src="${u.avatar}" style="width:35px;height:35px;border-radius:50%;margin-right:10px;border:1px solid #d4af37;object-fit:cover;">
                ${u.username}
            </a>`).join('');
    } catch (e) { console.error(e); }
}

function openSearchModal() { new bootstrap.Modal(document.getElementById('searchModal')).show(); }
function openEditBioModal() { new bootstrap.Modal(document.getElementById('editBioModal')).show(); }
</script>
{% endblock %}