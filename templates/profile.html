{% extends "base.html" %}

{% block content %}
<style>
/* --- MEVCUT TASARIMIN (KESİNLİKLE DOKUNULMADI) --- */
.ig-container { width: 100%; max-width: 935px; margin: 0 auto; padding: 30px 20px; color: var(--ig-text); font-family: 'Montserrat', sans-serif; }
.ig-header { display: flex; margin-bottom: 44px; align-items: center; border-bottom: 1px solid var(--ig-border); padding-bottom: 40px; }
.ig-avatar-area { flex: 1; display: flex; justify-content: center; position: relative; }
.avatar-wrapper { position: relative; cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.avatar-wrapper:hover { transform: scale(1.05); }
.profile-avatar { width: 150px !important; height: 150px !important; border-radius: 50% !important; object-fit: cover; border: 1px solid var(--ig-border); padding: 5px; background-color: var(--ig-bg); }
.ig-info-area { flex: 2; padding-left: 30px; }
.ig-user-row { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.profile-name { font-size: 28px; font-weight: 300; margin: 0; color: var(--ig-text); text-transform: uppercase; }

.verzia-gold-text { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; }
.gold-verify { font-size: 20px; background: linear-gradient(135deg, #a67c00 0%, #ffbf00 50%, #b8860b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0px 1px 1px rgba(0,0,0,0.3)); }

.btn-ig-edit, .btn-ig-follow { 
    background: transparent !important; border: 1px solid #bf953f !important; border-radius: 30px !important; 
    color: #bf953f !important; font-weight: 700; font-size: 14px; padding: 8px 20px; 
    cursor: pointer; transition: all 0.3s ease; display: inline-block; text-decoration: none;
}

.btn-plus-gold { width: 35px; height: 35px; border-radius: 50%; background: var(--v-gold-gradient); display: flex; align-items: center; justify-content: center; color: #000; font-size: 18px; cursor: pointer; margin-left: 10px; border: 1px solid #d4af37; transition: 0.3s; }
.btn-plus-gold:hover { transform: scale(1.1) rotate(90deg); }

.ig-stats { display: flex; gap: 40px; list-style: none; padding: 0; margin-bottom: 20px; }
.ig-stats li { font-size: 16px; color: var(--ig-text); }
.ig-stats b { font-weight: 600; }

.ig-photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 28px; margin-top: 10px; }
.grid-item { aspect-ratio: 1/1; overflow: hidden; background: var(--ig-border); position: relative; border-radius: 4px; }
.grid-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; cursor: pointer; }

/* 3D KALP ANİMASYONU STİLLERİ */
.big-heart { 
    position: absolute; top: 50%; left: 50%; 
    transform: translate(-50%, -50%) scale(0); 
    color: #fcf6ba; font-size: 100px; opacity: 0; 
    pointer-events: none; z-index: 100; 
    text-shadow: 0 0 30px rgba(191, 149, 63, 0.8);
}
.heart-pop { animation: heartPopAnim 0.8s ease-out; }
@keyframes heartPopAnim { 
    0% { transform: translate(-50%, -50%) scale(0); opacity: 0; } 
    50% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; } 
    100% { transform: translate(-50%, -50%) scale(1.6); opacity: 0; } 
}

/* GOLD ÇÖP KOVASI */
.delete-btn-overlay { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.85); color: #bf953f !important; border-radius: 50%; width: 34px; height: 34px; display: flex !important; align-items: center; justify-content: center; cursor: pointer; z-index: 1000; border: 1px solid #bf953f; transition: 0.4s; opacity: 0.8; }
.delete-btn-overlay:hover { opacity: 1; transform: scale(1.15); box-shadow: 0 0 15px rgba(191, 149, 63, 0.5); }

input[type="file"] { display: none !important; }

.post-modal-body { display: flex; padding: 0; min-height: 500px; flex-wrap: nowrap !important; }
.post-modal-img-area { flex: 1.2; background: #000; position: relative; display: flex; align-items: center; justify-content: center; }
.post-modal-img-area img { max-width: 100%; max-height: 80vh; object-fit: contain; }
.post-modal-info-area { flex: 0.8; display: flex; flex-direction: column; background: var(--modal-bg); border-left: 1px solid var(--ig-border); min-width: 350px !important; }

.v-modal-content { background-color: var(--modal-bg) !important; border: 1px solid #d4af37 !important; color: var(--ig-text) !important; border-radius: 12px; position: relative; overflow: hidden; }
.verzia-manual-close { position: absolute !important; top: 15px !important; left: 15px !important; background: none !important; border: none !important; color: #bf953f !important; font-size: 28px !important; font-weight: bold; cursor: pointer; z-index: 1060; }
</style>

<div class="ig-container" style="padding-left: 90px;"> 
    <header class="ig-header">
        <div class="ig-avatar-area">
            <div class="avatar-wrapper" {% if can_edit %}onclick="document.getElementById('avatarInput').click()"{% endif %}>
                <img class="profile-avatar" id="avatarPreview" src="{{ server_profile.avatar }}">
                <input type="file" id="avatarInput" accept="image/*" onchange="previewImage(event)">
            </div>
        </div>
        <div class="ig-info-area">
            <div class="ig-user-row">
                <h2 class="profile-name">{{ server_profile.username }}</h2>
                {% if server_profile.is_vip %}<i class="fa-solid fa-circle-check gold-verify"></i>{% endif %}
                {% if can_edit %}
                <button class="btn-ig-edit" onclick="openEditBioModal()">Profili Düzenle</button>
                <div class="btn-plus-gold" onclick="document.getElementById('photoUploadInput').click()"><i class="fa-solid fa-plus"></i></div>
                <form action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data" style="display:none;">
                    <input type="file" name="photo" id="photoUploadInput" onchange="this.form.submit()">
                </form>
                {% else %}
                <button class="btn-ig-follow" id="followBtn" onclick="toggleFollow('{{ server_profile.username }}')">
                    {% if is_following %}Takibi Bırak{% else %}Takip Et{% endif %}
                </button>
                {% endif %}
            </div>
            
            <ul class="ig-stats">
                <li><b>{{ photos|length }}</b> gönderi</li>
                <li {% if not server_profile.is_kurucu %}onclick="showUserList('followers')" style="cursor:pointer"{% endif %}>
                    <b id="followerCount">{{ server_profile.followers }}</b> takipçi
                </li>
                <li onclick="showUserList('following')" style="cursor:pointer">
                    <b>{{ server_profile.following }}</b> takip
                </li>
            </ul>
            
            <div class="ig-bio"><p class="mt-1" style="white-space: pre-wrap;">{{ server_profile.bio }}</p></div>
        </div>
    </header>

    <div class="ig-photo-grid">
        {% for photo in photos %}
        <div class="grid-item">
            {% if can_edit %}
            <div class="delete-btn-overlay" onclick="deleteMyPost('{{ photo.id }}')" title="Kaldır">
                <i class="fa-solid fa-trash-can"></i>
            </div>
            {% endif %}
            <img src="{{ photo.filename }}" onclick="openPostModal('{{ photo.id }}', '{{ photo.filename }}')">
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="userListModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content v-modal-content">
            <button type="button" class="verzia-manual-close" data-bs-dismiss="modal">&times;</button>
            <div style="padding:15px; border-bottom:1px solid var(--ig-border); text-align:center;">
                <h6 class="modal-title verzia-gold-text fw-bold m-0" id="userListTitle">Liste</h6>
            </div>
            <div class="modal-body p-0" id="userListContainer" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="postModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content v-modal-content">
            <button type="button" class="verzia-manual-close" data-bs-dismiss="modal">&times;</button>
            <div class="post-modal-body">
                <div class="post-modal-img-area" ondblclick="handleDoubleTap()">
                    <img id="modalImg" src="">
                    <i id="tapHeart" class="fa-solid fa-heart big-heart"></i>
                </div>
                <div class="post-modal-info-area">
                    <div style="padding:15px; border-bottom:1px solid var(--ig-border); text-align:center;">
                        <b class="verzia-gold-text">{{ server_profile.username }}</b>
                    </div>
                    <div id="commentBox" style="flex:1; padding:15px; overflow-y:auto; font-size:14px;"></div>
                    <div style="padding:15px; border-top:1px solid var(--ig-border);">
                        <i id="likeIcon" class="fa-regular fa-heart verzia-gold-text" style="font-size:24px; cursor:pointer;" onclick="toggleLike()"></i>
                        <div class="mt-1"><b><span id="likeCountDisplay">0</span> beğeni</b></div>
                    </div>
                    <div style="padding:10px; border-top:1px solid var(--ig-border);">
                        <div class="input-group">
                            <input type="text" id="newComment" class="form-control" placeholder="Yorum ekle..." style="background:transparent; border:none; color:var(--ig-text); outline:none;">
                            <button style="background:none; border:none; color:#bf953f; font-size:20px; cursor:pointer;" onclick="addComment()">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let activePostId = null;

// TAKİP LİSTESİ GÖRÜNTÜLEME FONKSİYONU
async function showUserList(type) {
    const pathArray = window.location.pathname.split('/');
    const username = pathArray[pathArray.length - 1];
    const container = document.getElementById('userListContainer');
    document.getElementById('userListTitle').innerText = type === 'followers' ? 'Takipçiler' : 'Takip Edilenler';
    container.innerHTML = '<p class="text-center opacity-50 p-4">Yükleniyor...</p>';
    new bootstrap.Modal(document.getElementById('userListModal')).show();
    try {
        const res = await fetch(`/get_user_list/${username}/${type}`);
        const users = await res.json();
        if(users.length === 0) {
            container.innerHTML = '<p class="text-center opacity-50 p-4">Bu liste gizlidir veya henüz kimse yok.</p>';
            return;
        }
        container.innerHTML = users.map(u => `
            <a href="/profile/${u.username}" style="display:flex;align-items:center;padding:12px;text-decoration:none;color:var(--ig-text);border-bottom:1px solid var(--ig-border);">
                <img src="${u.avatar}" style="width:35px;height:35px;border-radius:50%;margin-right:10px;border:1px solid #d4af37;object-fit:cover;">
                <span class="fw-bold">${u.username}</span>
            </a>`).join('');
    } catch(e) { container.innerHTML = '<p class="text-center text-danger p-4">Hata oluştu!</p>'; }
}

function handleDoubleTap() {
    const heart = document.getElementById('tapHeart');
    heart.classList.add('heart-pop');
    setTimeout(() => heart.classList.remove('heart-pop'), 800);
    toggleLike();
}

async function deleteMyPost(photoId) {
    if(confirm("Bu içeriği kaldırmak istediğinize emin misiniz?")) {
        try {
            const res = await fetch(`/delete_photo/${photoId}`, {method: 'POST'});
            const data = await res.json();
            if(data.status === "success") { location.reload(); }
        } catch(e) { console.error(e); }
    }
}

async function deleteComment(commentId, postId) {
    if(confirm("Bu yorumu silmek istediğinize emin misiniz?")) {
        try {
            const res = await fetch(`/delete_comment/${commentId}`, { method: 'POST' });
            const data = await res.json();
            if(data.status === "success") {
                loadComments(postId); 
            }
        } catch(e) { console.error(e); }
    }
}

async function openPostModal(postId, imgUrl) {
    activePostId = postId;
    document.getElementById('modalImg').src = imgUrl;
    new bootstrap.Modal(document.getElementById('postModal')).show();
    loadComments(postId);
}

async function loadComments(postId) {
    try {
        const res = await fetch(`/get_post_details/${postId}`);
        const data = await res.json();
        document.getElementById('likeCountDisplay').innerText = data.likes;
        document.getElementById('likeIcon').className = data.is_liked ? 'fa-solid fa-heart verzia-gold-text' : 'fa-regular fa-heart verzia-gold-text';
        
        const commentBox = document.getElementById('commentBox');
        if (data.comments.length > 0) {
            commentBox.innerHTML = data.comments.map(c => `
                <div class="mb-2 d-flex justify-content-between align-items-center">
                    <div>
                        <b class="verzia-gold-text">@${c.username}</b> ${c.text}
                    </div>
                    ${(c.can_delete) ? `
                    <i class="fa-solid fa-xmark" style="cursor:pointer; font-size:12px; color:#ff4d4d; opacity:0.8;" onclick="deleteComment('${c.id}', '${postId}')"></i>
                    ` : ''}
                </div>
            `).join('');
        } else {
            commentBox.innerHTML = '<p class="text-center opacity-50 mt-5">Yorum bulunamadı.</p>';
        }
    } catch(e) {}
}

async function addComment() {
    const input = document.getElementById('newComment');
    if(!input.value.trim()) return;
    await fetch(`/add_comment/${activePostId}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text: input.value})
    });
    input.value = '';
    loadComments(activePostId);
}

async function toggleLike() {
    const res = await fetch(`/like/${activePostId}`, {method: 'POST'});
    const data = await res.json();
    document.getElementById('likeCountDisplay').innerText = data.like_count;
    document.getElementById('likeIcon').className = data.status === 'liked' ? 'fa-solid fa-heart verzia-gold-text' : 'fa-regular fa-heart verzia-gold-text';
}

// PROFİL FOTOĞRAFI GÜNCELLEME VE VERİTABANINA MÜHÜRLEME
async function previewImage(event) {
    const file = event.target.files[0];
    if (!file) return;

    // 1. Önce ekranda hemen gösterelim (Kullanıcı deneyimi için)
    const reader = new FileReader();
    reader.onload = function(){ 
        document.getElementById('avatarPreview').src = reader.result; 
    };
    reader.readAsDataURL(file);

    // 2. Şimdi bu pırlantayı veritabanına mühürleyelim (Kalıcılık için)
    const formData = new FormData();
    formData.append('avatar', file);

    try {
        const res = await fetch('/update_avatar', {
            method: 'POST',
            body: formData
        });
        const data = await res.json();
        if (data.status === "success") {
            console.log("Profil fotoğrafı veritabanına mühürlendi! ✨");
        } else {
            console.error("Yükleme hatası:", data.message);
        }
    } catch(e) {
        console.error("Fetch hatası:", e);
    }
}
</script>
{% endblock %}