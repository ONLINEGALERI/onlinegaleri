{% extends "base.html" %}

{% block content %}
<style>
/* --- MEVCUT TASARIMIN (DOKUNULMADI) --- */
.ig-container { 
    width: 100%; 
    max-width: 935px; 
    margin: 0 auto; 
    padding: 30px 20px; 
    color: var(--ig-text); 
    font-family: 'Montserrat', sans-serif; 
}
.ig-header { display: flex; margin-bottom: 44px; align-items: center; border-bottom: 1px solid var(--ig-border); padding-bottom: 40px; }
.ig-avatar-area { flex: 1; display: flex; justify-content: center; position: relative; }
.avatar-wrapper { position: relative; cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.avatar-wrapper:hover { transform: scale(1.05); }
.profile-avatar { width: 150px !important; height: 150px !important; border-radius: 50% !important; object-fit: cover; border: 1px solid var(--ig-border); padding: 5px; background-color: var(--ig-bg); }
.ig-info-area { flex: 2; padding-left: 30px; }
.ig-user-row { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.profile-name { font-size: 28px; font-weight: 300; margin: 0; color: var(--ig-text); text-transform: uppercase; }

/* VERZIA GOLD DETAYLAR */
.verzia-gold-text { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; }
.gold-verify { font-size: 20px; background: linear-gradient(135deg, #a67c00 0%, #ffbf00 50%, #b8860b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0px 1px 1px rgba(0,0,0,0.3)); }

/* BUTONLAR */
.btn-ig-edit, .btn-ig-follow { 
    background: transparent !important; 
    border: 1px solid #bf953f !important; 
    border-radius: 4px !important; 
    background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    font-weight: 700; 
    font-size: 14px; 
    padding: 5px 12px; 
    cursor: pointer; 
    transition: all 0.3s ease;
    display: inline-block;
}

/* İSTATİSTİKLER */
.ig-stats { display: flex; gap: 40px; list-style: none; padding: 0; margin-bottom: 20px; }
.ig-stats li { font-size: 16px; color: var(--ig-text); }
.ig-stats b { font-weight: 600; }
.ig-bio { font-size: 16px; line-height: 1.5; color: var(--ig-text); }

/* GALERİ */
.ig-photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 28px; margin-top: 10px; }
.grid-item { aspect-ratio: 1/1; overflow: hidden; background: var(--ig-border); position: relative; border-radius: 4px; }
.grid-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; cursor: pointer; }

/* MODALLAR */
.v-modal-content { background-color: var(--modal-bg) !important; border: 1px solid #d4af37 !important; color: var(--ig-text) !important; border-radius: 12px; position: relative; }
.verzia-manual-close { position: absolute !important; top: 15px !important; right: 15px !important; background: none !important; border: none !important; color: #bf953f !important; font-size: 28px !important; font-weight: bold; cursor: pointer; z-index: 1060; transition: 0.3s; }

/* POST DETAYI */
.post-modal-dialog { max-width: 800px; }
.post-modal-body { display: flex; padding: 0; min-height: 500px; }
.post-modal-img { flex: 1.2; background: #000; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
.post-modal-img img { max-width: 100%; max-height: 80vh; object-fit: contain; }
.post-modal-side { flex: 0.8; display: flex; flex-direction: column; border-left: 1px solid var(--ig-border); background: var(--modal-bg); }

/* --- LUXE GOLD KALP ANİMASYONU --- */
.double-tap-heart {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
    color: #fcf6ba; /* Daha parlak beyaz altın tonu */
    font-size: 120px; opacity: 0; pointer-events: none; z-index: 10;
    text-shadow: 0 0 30px rgba(191, 149, 63, 0.8), 0 0 60px rgba(252, 246, 186, 0.4); /* Pırlanta parlama efekti */
}
.heart-animate { animation: heartFadeIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes heartFadeIn {
    0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
    40% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
    100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
}

/* YORUM GÖNDER BUTONU */
.send-comment-btn {
    background: none !important; border: none !important;
    color: #bf953f !important; font-size: 22px !important;
    padding: 0 10px !important; transition: 0.3s; cursor: pointer;
}
.send-comment-btn:hover { transform: scale(1.2) rotate(-10deg); filter: brightness(1.3); }

#avatarInput, #photoUploadInput { display: none; }
</style>

<aside class="side-nav">
    <div class="nav-top">
        <a href="{{ url_for('index') }}"><i class="fa-solid fa-house"></i></a>
        <i class="fa-solid fa-magnifying-glass" onclick="openSearchModal()"></i>
        <a href="{{ url_for('profile', username=current_user.username) }}"><i class="fa-solid fa-user-circle active"></i></a>
        <div class="notif-wrapper" onclick="openNotifModal()">
            <i id="notifBell" class="fa-solid fa-bell {% if unread_notifications_count > 0 %}shake-active{% endif %}"></i>
        </div>
        <a href="{{ url_for('profile', username='VERZİA') }}" class="v-logo-nav">V</a>
    </div>
    <div class="nav-bottom">
        <a href="{{ url_for('settings') }}"><i class="fa-solid fa-gear"></i></a>
        <a href="{{ url_for('logout') }}"><i class="fa-solid fa-right-from-bracket"></i></a>
    </div>
</aside>

<div class="ig-container" style="padding-left: 90px;"> 
    <header class="ig-header">
        <div class="ig-avatar-area">
            <div class="avatar-wrapper" {% if can_edit %}onclick="document.getElementById('avatarInput').click()"{% endif %}>
                <img class="profile-avatar" id="avatarPreview" src="{{ server_profile.avatar }}">
            </div>
        </div>
        <div class="ig-info-area">
            <div class="ig-user-row">
                <h2 class="profile-name">{{ server_profile.username }}</h2>
                {% if server_profile.is_vip %}<i class="fa-solid fa-circle-check gold-verify"></i>{% endif %}
                {% if can_edit %}
                <button class="btn-ig-edit" onclick="openEditBioModal()">Profili Düzenle</button>
                {% endif %}
            </div>
            <ul class="ig-stats">
                <li><b>{{ photos|length }}</b> gönderi</li>
                <li onclick="showUserList('followers')"><b>{{ server_profile.followers }}</b> takipçi</li>
                <li onclick="showUserList('following')"><b>{{ server_profile.following }}</b> takip</li>
            </ul>
            <div class="ig-bio"><p class="mt-1" style="white-space: pre-wrap;">{{ server_profile.bio }}</p></div>
        </div>
    </header>

    <div class="ig-photo-grid">
        {% for photo in photos %}
        <div class="grid-item" onclick="viewPost('{{ photo.id }}', '{{ url_for('uploaded_file', filename=photo.filename) }}')">
            <img src="{{ url_for('uploaded_file', filename=photo.filename) }}">
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="postDetailModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered post-modal-dialog">
        <div class="modal-content v-modal-content">
            <button type="button" class="verzia-manual-close" data-bs-dismiss="modal">&times;</button>
            <div class="post-modal-body">
                <div class="post-modal-img" ondblclick="animateHeart()">
                    <img id="modalPostImg" src="" alt="post">
                    <i id="largeHeart" class="fa-solid fa-heart double-tap-heart"></i>
                </div>
                <div class="post-modal-side">
                    <div style="padding:15px; border-bottom:1px solid var(--ig-border); display:flex; align-items:center; gap:10px;">
                        <img src="{{ server_profile.avatar }}" style="width:32px; height:32px; border-radius:50%; object-fit:cover; border:1px solid #bf953f;">
                        <b class="verzia-gold-text">{{ server_profile.username }}</b>
                    </div>
                    <div id="modalComments" style="flex:1; padding:15px; overflow-y:auto; max-height:350px;"></div>
                    <div style="padding:15px; border-top:1px solid var(--ig-border);">
                        <i id="heartAction" class="fa-regular fa-heart verzia-gold-text" style="font-size:24px; cursor:pointer;" onclick="likePost()"></i>
                        <div class="mt-2" style="font-size:14px;"><b id="modalLikeCount">0</b> beğeni</div>
                    </div>
                    <div style="padding:15px; border-top:1px solid var(--ig-border);">
                        <div class="input-group align-items-center">
                            <input type="text" id="commentInput" class="form-control" placeholder="Yorum ekle..." style="background:transparent; border:none; color:var(--ig-text); outline:none;">
                            <button class="send-comment-btn" type="button" onclick="submitComment()">
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentPostId = null;

async function viewPost(postId, imgUrl) {
    currentPostId = postId;
    document.getElementById('modalPostImg').src = imgUrl;
    new bootstrap.Modal(document.getElementById('postDetailModal')).show();
    loadPostData(postId);
}

async function loadPostData(postId) {
    try {
        const response = await fetch(`/get_post_details/${postId}`);
        const data = await response.json();
        document.getElementById('modalLikeCount').innerText = data.likes;
        document.getElementById('heartAction').className = data.is_liked ? 'fa-solid fa-heart verzia-gold-text' : 'fa-regular fa-heart verzia-gold-text';
        document.getElementById('modalComments').innerHTML = data.comments.map(c => `<div class="mb-2"><b class="verzia-gold-text">@${c.username}</b> <span>${c.text}</span></div>`).join('');
    } catch (e) {}
}

function animateHeart() {
    const largeHeart = document.getElementById('largeHeart');
    largeHeart.classList.add('heart-animate');
    setTimeout(() => largeHeart.classList.remove('heart-animate'), 800);
    if (document.getElementById('heartAction').classList.contains('fa-regular')) {
        likePost();
    }
}

async function likePost() {
    if (!currentPostId) return;
    try {
        const response = await fetch(`/like_post/${currentPostId}`, { method: 'POST' });
        const data = await response.json();
        if (data.status === 'success') {
            const heart = document.getElementById('heartAction');
            heart.classList.toggle('fa-regular');
            heart.classList.toggle('fa-solid');
            document.getElementById('modalLikeCount').innerText = data.likes;
        }
    } catch (e) {}
}

async function submitComment() {
    const input = document.getElementById('commentInput');
    if (!input.value.trim() || !currentPostId) return;
    try {
        await fetch(`/add_comment/${currentPostId}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: input.value})
        });
        input.value = '';
        loadPostData(currentPostId);
    } catch (e) {}
}

function openEditBioModal() { new bootstrap.Modal(document.getElementById('editBioModal')).show(); }
</script>
{% endblock %}