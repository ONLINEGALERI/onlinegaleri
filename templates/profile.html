{% extends "base.html" %}

{% block title %}Profil - {{ username if username else 'Kullanıcı' }}{% endblock %}

{% block head %}
    <style>
        /* Profile page styles - modern Pinterest/TikTok mix */
        .profile-hero{background: linear-gradient(90deg,#f6f9ff,#eef6f3);padding:40px 0;border-radius:8px}
        .profile-card{background:white;border-radius:12px;padding:24px;box-shadow:0 6px 18px rgba(20,30,40,0.08)}
        .profile-avatar{width:120px;height:120px;border-radius:50%;object-fit:cover;border:6px solid rgba(255,255,255,0.9);box-shadow:0 6px 18px rgba(20,30,40,0.08)}
        .profile-name{font-size:1.35rem;font-weight:700;margin-bottom:6px}
        .profile-handle{color:#6b7280;margin-bottom:10px}
        .profile-bio{color:#374151;margin-bottom:14px}
        .profile-stats{display:flex;gap:18px}
        .profile-stats .stat{font-weight:700;text-align:center}

        /* Tabs */
        .tabs{display:flex;gap:8px;border-bottom:1px solid #e6e9ee;margin-top:18px}
        .tab{padding:10px 14px;border-radius:8px 8px 0 0;background:transparent;color:#374151;cursor:pointer}
        .tab.active{background:white;box-shadow:0 -1px 0 rgba(0,0,0,0.03);border-bottom:2px solid #fff}

        /* Masonry grid (Pinterest-like) */
        .masonry{column-gap:16px}
        .masonry .card{display:inline-block;width:100%;margin:0 0 16px;border-radius:12px;overflow:hidden;background:white;box-shadow:0 6px 18px rgba(20,30,40,0.06);transition:transform .25s ease,box-shadow .25s ease}
        .masonry .card img{width:100%;height:auto;display:block}
        .masonry .card:hover{transform:translateY(-6px) scale(1.01);box-shadow:0 12px 30px rgba(20,30,40,0.12)}
        .card .desc{padding:10px 12px;color:#374151;font-size:0.95rem}

        /* Reposts list (TikTok-like) */
        .reposts .repost{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;background:white;box-shadow:0 6px 18px rgba(20,30,40,0.04);margin-bottom:12px;transition:box-shadow .18s ease}
        .reposts .repost:hover{box-shadow:0 14px 34px rgba(20,30,40,0.12)}
        .repost .mini-avatar{width:44px;height:44px;border-radius:50%;object-fit:cover}
        .repost .meta{flex:1}
        .repost .meta .user{font-weight:700}
        .repost .meta .time{color:#6b7280;font-size:0.85rem}
        .repost .thumb{width:84px;height:64px;object-fit:cover;border-radius:8px}

        /* Responsive columns */
        @media (max-width:599px){.masonry{column-count:2;padding:8px}} 
        @media (min-width:600px) and (max-width:899px){.masonry{column-count:3;padding:12px}} 
        @media (min-width:900px){.masonry{column-count:4;padding:16px}}

        /* Offcanvas tweaks if needed */
        #authOffcanvas .offcanvas-body{padding-top:0}

        /* Small helpers */
        .muted{color:#6b7280}
    </style>
{% endblock %}

{% block content %}
<div class="profile-hero">
    <div class="container">
        <div class="profile-card d-flex gap-4 align-items-center">
            <img class="profile-avatar" src="{% if server_profile and server_profile.avatar %}{{ server_profile.avatar }}{% else %}https://picsum.photos/seed/profile/400/400{% endif %}" alt="avatar">
            <div style="flex:1;min-width:0">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div id="profileName" class="profile-name">{% if server_profile and server_profile.name %}{{ server_profile.name }}{% else %}{{ username|e }}{% endif %}</div>
                            <div id="profileHandle" class="profile-handle">{% if server_profile and server_profile.handle %}{{ server_profile.handle }}{% else %}@{{ username|e }}{% endif %}</div>
                            <div id="profileBio" class="profile-bio">{% if server_profile and server_profile.bio %}{{ server_profile.bio }}{% else %}Profil bilgisi yok.{% endif %}</div>
                        </div>
                            <div class="text-end profile-actions">
                            <button id="followBtn" class="btn btn-outline-primary" data-username="{{ username|e }}" style="display:none">Takip Et</button>
                            <button id="editProfileBtn" class="btn btn-primary ms-2" data-bs-toggle="modal" data-bs-target="#editProfileModal" style="display:none">Profili Düzenle</button>
                        </div>
                    </div>

                <div class="profile-stats mt-3">
                            <div class="stat"><div class="muted">Takipçi</div><div id="followerCount">{% if server_profile %}{{ server_profile.followers }}{% else %}0{% endif %}</div></div>
                            <div class="stat"><div class="muted">Takip</div><div id="followingCount">{% if server_profile %}{{ server_profile.following }}{% else %}0{% endif %}</div></div>
                            <div class="stat"><div class="muted">Paylaşım</div><div id="postCount">{% if server_profile %}{{ server_profile.posts }}{% else %}0{% endif %}</div></div>
                        </div>
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="profile-card">
        <div class="d-flex justify-content-between align-items-center">
            <div class="tabs" role="tablist">
                <div class="tab active" data-tab="pins">Pinler / Gönderiler</div>
                <div class="tab" data-tab="reposts">Repostlar / Tekrar Paylaşımlar</div>
            </div>
            <div>
                {% if can_edit %}
                <a class="btn btn-sm btn-outline-secondary me-2" href="{{ url_for('profile_archive', username=username) }}">Arşivim</a>
                {% endif %}
            </div>
            <div class="muted small">Sırala: <select class="form-select form-select-sm d-inline-block" style="width:auto;margin-left:8px"><option>Yeni</option><option>Popüler</option></select></div>
        </div>

        <!-- Pins -->
        <div id="pins" class="tab-panel mt-3">
            {% if can_edit %}
            <div class="mb-3">
                <form action="{{ url_for('upload_post') }}" method="POST" enctype="multipart/form-data" class="d-flex gap-2 align-items-center">
                    <input type="file" name="photo" accept="image/*" class="form-control form-control-sm" required>
                    <input type="text" name="caption" placeholder="Açıklama (opsiyonel)" class="form-control form-control-sm">
                    <button class="btn btn-sm btn-primary">Yükle</button>
                </form>
            </div>
            {% endif %}
            <div class="masonry" id="masonry">
                <!-- cards generated by JS -->
            </div>
        </div>

        <!-- Reposts -->
        <div id="reposts" class="tab-panel mt-3" style="display:none">
            <div class="reposts" id="reposts-list">
                <!-- repost items generated by JS -->
            </div>
        </div>
    </div>
</div>

<script>
    // Tabs behavior
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',e=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        e.currentTarget.classList.add('active');
        const tab = e.currentTarget.dataset.tab;
        document.querySelectorAll('.tab-panel').forEach(p=>p.style.display = 'none');
        document.getElementById(tab).style.display = '';
    }));

    // Render server posts if provided; otherwise fallback to placeholder images
    const postsFromServer = {% if posts %}{{ posts|tojson|safe }}{% else %}null{% endif %};
    const masonry = document.getElementById('masonry');
        if(postsFromServer && postsFromServer.length){
        postsFromServer.forEach(p=>{
            const card = document.createElement('div'); card.className='card post-card';
            card.dataset.postId = p.id;
            // build inner html with dropdown placeholder
            const inner = document.createElement('div'); inner.className = 'post-inner';
            inner.innerHTML = `<img class="post-thumb" src="${p.url}" alt="img" style="cursor:pointer"><div class=\"desc\">${p.caption || ''}</div>`;
            card.appendChild(inner);
            // owner actions: three-dot menu
            if({{ 'true' if (can_edit or (current_user.is_authenticated and current_user.is_admin)) else 'false' }}){
                const menu = document.createElement('div'); menu.className = 'post-menu';
                menu.innerHTML = `
                    <div class="dropdown" style="position:absolute;top:8px;right:8px">
                        <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="pm-${p.id}" data-bs-toggle="dropdown" aria-expanded="false">&#8230;</button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="pm-${p.id}">
                            <li><button class="dropdown-item archive-btn">Arşivle</button></li>
                            <li><button class="dropdown-item unarchive-btn" style="display:none">Arşivi Aç</button></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item text-danger delete-btn">Kalıcı Sil</button></li>
                        </ul>
                    </div>`;
                card.style.position='relative';
                card.appendChild(menu);
                // wire buttons
                menu.querySelector('.archive-btn').addEventListener('click', function(ev){ ev.stopPropagation(); if(!confirm('Gönderiyi arşivlemek istediğinize emin misiniz?')) return; fetch('/post/'+card.dataset.postId+'/archive',{method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}}).then(r=>r.json()).then(j=>{ if(j && j.status==='ok'){ card.remove(); const pc = document.getElementById('postCount'); if(pc) pc.textContent = Math.max(0, parseInt(pc.textContent||0) - 1); } else { alert('Arşivleme başarısız'); }}).catch(e=>{alert('Arşivleme başarısız');}); });
                menu.querySelector('.unarchive-btn').addEventListener('click', function(ev){ ev.stopPropagation(); fetch('/post/'+card.dataset.postId+'/unarchive',{method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}}).then(r=>r.json()).then(j=>{ if(j && j.status==='ok'){ location.reload(); } else { alert('İşlem başarısız'); }}).catch(e=>{alert('Hata')}); });
                menu.querySelector('.delete-btn').addEventListener('click', function(ev){ ev.stopPropagation(); if(!confirm('Bu gönderiyi kalıcı olarak silmek istediğinize emin misiniz?')) return; fetch('/post/'+card.dataset.postId+'/delete',{method:'POST', headers:{'X-Requested-With':'XMLHttpRequest','Content-Type':'application/x-www-form-urlencoded'}}).then(r=>{
                    // try to parse JSON, but be defensive
                    return r.json().catch(()=>null);
                }).then(j=>{ if(j && j.status==='ok'){ card.remove(); const pc = document.getElementById('postCount'); if(pc) pc.textContent = Math.max(0, parseInt(pc.textContent||0) - 1); } else if(j && j.status === 'error'){ alert(j.message || 'Silme başarısız'); } else { /* fallback: reload to reflect server-side change */ location.reload(); } }).catch(e=>{alert('Silme başarısız')}); });
            }
            masonry.appendChild(card);
        });
    } else {
        // No posts: show a friendly empty state. Users should create posts themselves.
        masonry.innerHTML = '';
        const empty = document.createElement('div');
        empty.className = 'p-4 text-center muted';
        empty.innerHTML = `
            <div style="padding:36px 12px;border:2px dashed #eef2f7;border-radius:12px">
                <h5 class="mb-2">Henüz gönderi yok</h5>
                <div class="mb-3">Bu kullanıcı henüz paylaşım yapmamış. Gönderiler kullanıcılar tarafından yüklendikçe burada görünür.</div>
                ${ canEdit ? '<button class="btn btn-primary" onclick="document.querySelector(\'input[name=\\\"photo\\\"]\').click()">İlk paylaşımı yap</button>' : '' }
            </div>`;
        masonry.appendChild(empty);
    }

    // No sample reposts: show empty state so users create their own reposts
    (function(){
        const reposts = [];
        const repostsList = document.getElementById('reposts-list');
        if(!reposts || reposts.length === 0){
            const msg = document.createElement('div');
            msg.className = 'p-4 text-center muted';
            msg.innerHTML = '<div style="padding:20px;border-radius:8px;background:#fbfdff">Henüz yeniden paylaşım yok. Kullanıcılar kendi repostlarını yaptıkça burada görünecek.</div>';
            repostsList.appendChild(msg);
            return;
        }
        reposts.forEach(r=>{
            const el = document.createElement('div'); el.className='repost';
            el.innerHTML = `<img class="mini-avatar" src="${r.avatar}"><div class="meta"><div class="user">${r.user}</div><div class="time">${r.time}</div><div class="text">${r.text}</div></div>${r.thumb?`<img class="thumb" src="${r.thumb}">`:''}`;
            repostsList.appendChild(el);
        });
    })();

    // Ensure images load for masonry columns (optional: could use imagesLoaded lib)
    window.addEventListener('load',()=>{ /* nothing extra needed for CSS column masonry */ });
</script>

<!-- Image lightbox modal -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-body p-0">
                <img id="imageModalImg" src="" alt="" style="width:100%;height:auto;display:block">
            </div>
            <div class="modal-footer">
                <div class="me-auto" id="imageModalCaption"></div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
        const masonry = document.getElementById('masonry');
        if(!masonry) return;
        masonry.addEventListener('click', function(e){
            const img = e.target.closest('.post-thumb');
            if(!img) return;
            const card = img.closest('.post-card');
            const caption = card ? (card.querySelector('.desc') ? card.querySelector('.desc').textContent : '') : '';
            const src = img.src;
            const modalImg = document.getElementById('imageModalImg');
            const modalCap = document.getElementById('imageModalCaption');
            modalImg.src = src;
            modalCap.textContent = caption || '';
            const modalEl = document.getElementById('imageModal');
            const m = new bootstrap.Modal(modalEl);
            m.show();
        });
    })();
</script>
<!-- Edit profile modal and localStorage-based personalization -->
<div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editProfileLabel">Profili Düzenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body">
                <form id="editProfileForm">
                    <div class="mb-2">
                        <label class="form-label">Görünen ad</label>
                        <input id="editName" class="form-control" type="text">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Kullanıcı etiketi (handle)</label>
                        <input id="editHandle" class="form-control" type="text">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Avatar URL</label>
                        <input id="editAvatar" class="form-control" type="text" placeholder="https://...">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Yeni Kullanıcı Adı</label>
                        <input id="newUsername" class="form-control" type="text" placeholder="yeni_kullanici_adi">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Mevcut Parola (onay)</label>
                        <input id="confirmPassword" class="form-control" type="password" placeholder="Mevcut parolanız">
                        <div class="form-text">Kullanıcı adını değiştirmek için mevcut parolanızı girin.</div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Biyografi</label>
                        <textarea id="editBio" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="row gx-2">
                        <div class="col">
                            <label class="form-label">Takipçi</label>
                            <input id="editFollowers" class="form-control" type="text" readonly>
                        </div>
                        <div class="col">
                            <label class="form-label">Takip</label>
                            <input id="editFollowing" class="form-control" type="text" readonly>
                        </div>
                        <div class="col">
                            <label class="form-label">Paylaşım</label>
                            <input id="editPosts" class="form-control" type="text" readonly>
                        </div>
                    </div>
                    <div class="mt-3 text-end">
                        <button type="button" id="saveProfileBtn" class="btn btn-success">Kaydet</button>
                        <button type="button" id="changeUsernameBtn" class="btn btn-outline-secondary ms-2">Kullanıcı Adını Değiştir</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    (function(){
        const viewedUsername = "{{ username|e }}";
        const serverProfile = {% if server_profile %}{{ server_profile|tojson|safe }}{% else %}null{% endif %};
        const canEdit = {% if can_edit %}true{% else %}false{% endif %};
        const isFollowingInitial = {% if is_following %}true{% else %}false{% endif %};
        const editBtn = document.getElementById('editProfileBtn');
        const avatarEl = document.querySelector('.profile-avatar');
        const nameEl = document.getElementById('profileName');
        const handleEl = document.getElementById('profileHandle');
        const bioEl = document.getElementById('profileBio');
        const followerEl = document.getElementById('followerCount');
        const followingEl = document.getElementById('followingCount');
        const postEl = document.getElementById('postCount');

        function storageKey(user){ return 'profile::' + user; }

        function loadProfile(user){
            if(!user) return;
            // Prefer server-side profile if available
            if(serverProfile && serverProfile.username && serverProfile.username === user){
                if(serverProfile.avatar) avatarEl.src = serverProfile.avatar;
                if(serverProfile.name) nameEl.textContent = serverProfile.name;
                if(serverProfile.handle) handleEl.textContent = serverProfile.handle;
                if(serverProfile.bio) bioEl.textContent = serverProfile.bio;
                if(serverProfile.followers) followerEl.textContent = serverProfile.followers;
                if(serverProfile.following) followingEl.textContent = serverProfile.following;
                if(serverProfile.posts) postEl.textContent = serverProfile.posts;
                return;
            }
            const raw = localStorage.getItem(storageKey(user));
            if(raw){
                try{
                    const data = JSON.parse(raw);
                    if(data.avatar) avatarEl.src = data.avatar;
                    if(data.name) nameEl.textContent = data.name;
                    if(data.handle) handleEl.textContent = data.handle;
                    if(data.bio) bioEl.textContent = data.bio;
                    if(data.followers) followerEl.textContent = data.followers;
                    if(data.following) followingEl.textContent = data.following;
                    if(data.posts) postEl.textContent = data.posts;
                }catch(e){console.error(e)}
            }
        }

        function openEdit(){
            if(!viewedUsername){
                alert('Önce bir kullanıcı adı girip profili açmalısın.');
                return;
            }
            // If server profile and editable, populate from server
            if(serverProfile && serverProfile.username === viewedUsername){
                document.getElementById('editName').value = serverProfile.name || nameEl.textContent || '';
                document.getElementById('editHandle').value = serverProfile.handle || handleEl.textContent || '';
                document.getElementById('editAvatar').value = serverProfile.avatar || avatarEl.src || '';
                document.getElementById('editBio').value = serverProfile.bio || bioEl.textContent || '';
                document.getElementById('editFollowers').value = serverProfile.followers || followerEl.textContent || '';
                document.getElementById('editFollowing').value = serverProfile.following || followingEl.textContent || '';
                document.getElementById('editPosts').value = serverProfile.posts || postEl.textContent || '';
                return;
            }
            // populate fields from localStorage fallback
            const raw = localStorage.getItem(storageKey(viewedUsername));
            const d = raw ? JSON.parse(raw) : {};
            document.getElementById('editName').value = d.name || nameEl.textContent || '';
            document.getElementById('editHandle').value = d.handle || handleEl.textContent || '';
            document.getElementById('editAvatar').value = d.avatar || avatarEl.src || '';
            document.getElementById('editBio').value = d.bio || bioEl.textContent || '';
            document.getElementById('editFollowers').value = d.followers || followerEl.textContent || '';
            document.getElementById('editFollowing').value = d.following || followingEl.textContent || '';
            document.getElementById('editPosts').value = d.posts || postEl.textContent || '';
        }

        function saveProfile(){
            const payload = {
                name: document.getElementById('editName').value.trim(),
                handle: document.getElementById('editHandle').value.trim(),
                avatar: document.getElementById('editAvatar').value.trim(),
                bio: document.getElementById('editBio').value.trim()
            };
            // If serverProfile and editing is allowed, save to server
            if(serverProfile && canEdit){
                fetch('/profile/save', {method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:new URLSearchParams(payload)})
                    .then(r=>r.json()).then(j=>{
                        // on success, reload from server
                        loadProfile(viewedUsername);
                        try{ const modalEl = document.getElementById('editProfileModal'); const m = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl); m.hide(); }catch(e){}
                    }).catch(e=>console.error(e));
                return;
            }
            localStorage.setItem(storageKey(viewedUsername), JSON.stringify(payload));
            // apply
            loadProfile(viewedUsername);
            // close modal
            try{ const modalEl = document.getElementById('editProfileModal'); const m = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl); m.hide(); }catch(e){}
        }

        // If a username is present, show edit button (only if allowed) and load saved profile
        if(viewedUsername && viewedUsername.length>0){
            editBtn.style.display = canEdit ? '' : 'none';
            loadProfile(viewedUsername);
            // follow button logic: show only when logged-in user is not the owner
            const followBtn = document.getElementById('followBtn');
            const isOwner = canEdit;
                if(!isOwner){
                followBtn.style.display = '';
                followBtn.textContent = isFollowingInitial ? 'Takipten Çık' : 'Takip Et';
                followBtn.addEventListener('click', function(){
                    const username = this.dataset.username;
                    const action = this.textContent.trim() === 'Takip Et' ? 'follow' : 'unfollow';
                    fetch('/' + action + '/' + encodeURIComponent(username), {method:'POST', headers:{'X-Requested-With':'XMLHttpRequest'}})
                        .then(res=>res.json())
                        .then(json=>{
                            if(json.status === 'ok'){
                                // update counts
                                document.getElementById('followerCount').textContent = json.followers;
                                document.getElementById('followingCount').textContent = json.following;
                                followBtn.textContent = action === 'follow' ? 'Takipten Çık' : 'Takip Et';
                            } else {
                                alert(json.message || 'İşlem başarısız');
                            }
                        }).catch(e=>{console.error(e); alert('İstek başarısız oldu')});
                });
            } else {
                // owner can edit avatar via modal - attach upload handler
                document.getElementById('saveProfileBtn').addEventListener('click', saveProfile);
            }
            if(canEdit){
                editBtn.addEventListener('click', openEdit);
                // avatar upload handling inside modal
                const avatarFileInput = document.createElement('input');
                avatarFileInput.type = 'file';
                avatarFileInput.accept = 'image/*';
                avatarFileInput.className = 'form-control mt-2';
                avatarFileInput.id = 'avatarFileInput';
                const formBody = document.querySelector('#editProfileForm');
                const existing = document.getElementById('avatarFileInput');
                if(!existing) formBody.insertBefore(avatarFileInput, document.getElementById('editBio').nextSibling);
                avatarFileInput.addEventListener('change', function(){
                    const f = this.files[0];
                    if(!f) return;
                    // client-side crop & compress to square using canvas
                    const reader = new FileReader();
                    reader.onload = function(ev){
                        const img = new Image();
                        img.onload = function(){
                            const size = Math.min(img.width, img.height);
                            const sx = (img.width - size)/2;
                            const sy = (img.height - size)/2;
                            const canvas = document.createElement('canvas');
                            const target = 400; // final size
                            canvas.width = target; canvas.height = target;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, sx, sy, size, size, 0, 0, target, target);
                            // compress to jpeg
                            canvas.toBlob(function(blob){
                                const fd = new FormData(); fd.append('avatar', blob, f.name.replace(/\.[^.]+$/, '.jpg'));
                                fetch('/profile/upload-avatar', {method:'POST', body: fd})
                                    .then(r=>r.json())
                                    .then(j=>{
                                        if(j.status === 'ok' && j.avatar){
                                            document.querySelector('.profile-avatar').src = j.avatar;
                                            document.getElementById('editAvatar').value = j.avatar;
                                        } else {
                                            alert(j.message || 'Yükleme başarısız');
                                        }
                                    }).catch(e=>{console.error(e); alert('Yükleme hatası')});
                            }, 'image/jpeg', 0.86);
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(f);
                });
                document.getElementById('changeUsernameBtn').addEventListener('click', function(){
                    const newU = document.getElementById('newUsername').value.trim();
                    const pwd = document.getElementById('confirmPassword').value;
                    if(!newU || !pwd){ alert('Yeni kullanıcı adı ve parola gerekli'); return; }
                    fetch('/account/change-username', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({new_username:newU, password:pwd})})
                        .then(r=>r.json())
                        .then(j=>{
                            if(j.status === 'ok'){
                                alert('Kullanıcı adı değiştirildi');
                                // update visible username
                                document.getElementById('profileName').textContent = j.username;
                                // update follow button dataset
                                const fb = document.getElementById('followBtn'); if(fb) fb.dataset.username = j.username;
                                // update navbar label (if present)
                                try{ document.querySelector('.dropdown-toggle').textContent = j.username; }catch(e){}
                                // clear inputs
                                document.getElementById('newUsername').value = '';
                                document.getElementById('confirmPassword').value = '';
                            } else {
                                alert(j.message || 'Değişiklik başarısız');
                            }
                        }).catch(e=>{ alert('İstek başarısız'); console.error(e); });
                });
            }
        } else {
            // no username -> inform user to open a profile via lookup
            editBtn.style.display = 'none';
        }
    })();
</script>
{% endblock %}