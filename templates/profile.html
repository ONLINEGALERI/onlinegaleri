{% extends "base.html" %}

{% block content %}
<style>
/* --- MEVCUT TASARIMIN (DOKUNULMADI) --- */
.ig-container { 
    width: 100%; 
    max-width: 935px; 
    margin: 0 auto; 
    padding: 30px 20px; 
    color: var(--ig-text); 
    font-family: 'Montserrat', sans-serif; 
}
.ig-header { display: flex; margin-bottom: 44px; align-items: center; border-bottom: 1px solid var(--ig-border); padding-bottom: 40px; }
.ig-avatar-area { flex: 1; display: flex; justify-content: center; position: relative; }
.avatar-wrapper { position: relative; cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
.avatar-wrapper:hover { transform: scale(1.05); }
.profile-avatar { width: 150px !important; height: 150px !important; border-radius: 50% !important; object-fit: cover; border: 1px solid var(--ig-border); padding: 5px; background-color: var(--ig-bg); }
.ig-info-area { flex: 2; padding-left: 30px; }
.ig-user-row { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.profile-name { font-size: 28px; font-weight: 300; margin: 0; color: var(--ig-text); text-transform: uppercase; }

/* VERZIA GOLD DETAYLAR */
.verzia-gold-text { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: bold; }
.gold-verify { font-size: 20px; background: linear-gradient(135deg, #a67c00 0%, #ffbf00 50%, #b8860b 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0px 1px 1px rgba(0,0,0,0.3)); }
body:not(.light-mode) .gold-verify { background: linear-gradient(135deg, #d4af37 0%, #fff9e3 50%, #c5a028 100%); -webkit-background-clip: text; }

/* BUTONLAR - GOLD GRADIENT */
.btn-ig-edit, .btn-ig-follow { 
    background: transparent !important; 
    border: 1px solid #bf953f !important; 
    border-radius: 4px !important; 
    background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    font-weight: 700; 
    font-size: 14px; 
    padding: 5px 12px; 
    cursor: pointer; 
    transition: all 0.3s ease;
    display: inline-block;
}
.btn-ig-edit:hover, .btn-ig-follow:hover {
    filter: drop-shadow(0 0 5px rgba(252, 246, 186, 0.4));
    border-color: #fcf6ba !important;
    transform: scale(1.02);
}

.verzia-gold-btn { background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728) !important; color: #000 !important; font-weight: bold; border: none !important; padding: 8px 20px; border-radius: 5px; cursor: pointer; transition: transform 0.2s; }
.verzia-gold-btn:hover { transform: scale(1.05); }

/* Ä°STATÄ°STÄ°KLER */
.ig-stats { display: flex; gap: 40px; list-style: none; padding: 0; margin-bottom: 20px; }
.ig-stats li { font-size: 16px; color: var(--ig-text); }
.ig-stats b { font-weight: 600; }
.ig-bio { font-size: 16px; line-height: 1.5; color: var(--ig-text); }

/* GALERÄ° */
.ig-photo-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 28px; margin-top: 10px; }
.grid-item { aspect-ratio: 1/1; overflow: hidden; background: var(--ig-border); position: relative; border-radius: 4px; }
.grid-item img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; cursor: pointer; }

.no-posts {
    grid-column: 1 / -1; text-align: center; padding: 80px 20px;
    border: 1px dashed #d4af37; border-radius: 12px; background: rgba(212, 175, 55, 0.03);
}

/* SOL BAR TASARIMI */
.side-nav {
    width: 70px; 
    background-color: var(--ig-sidebar-bg); 
    border-right: 1px solid var(--ig-border);
    display: flex; 
    flex-direction: column; 
    align-items: center;
    padding: 25px 0; 
    position: fixed; 
    height: 100vh; 
    left: 0; 
    top: 0; 
    z-index: 999;
    justify-content: space-between; 
}

/* TÃœM Ä°KONLAR VE V LOGO ARASINDAKÄ° SÄ°METRÄ° */
.nav-top, .nav-bottom { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    gap: 35px !important; 
}

/* --- ANÄ°MASYONLU VE LÃœKS V LOGO STÄ°LÄ° (360 DÃ–NÃœÅžLÃœ) --- */
.v-logo-nav {
    font-family: 'Cinzel', serif; 
    font-weight: 700;
    font-size: 28px;
    background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-decoration: none;
    transition: 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55); /* Yaylanarak dÃ¶nme efekti */
    cursor: pointer;
    display: inline-block;
    filter: drop-shadow(0 0 5px rgba(191, 149, 63, 0.4));
    animation: goldPulse 3s infinite ease-in-out; 
}

@keyframes goldPulse {
    0% { filter: drop-shadow(0 0 5px rgba(252, 246, 186, 0.4)); transform: scale(1); }
    50% { filter: drop-shadow(0 0 20px rgba(252, 246, 186, 0.9)); transform: scale(1.08); }
    100% { filter: drop-shadow(0 0 5px rgba(252, 246, 186, 0.4)); transform: scale(1); }
}

/* ÃœZERÄ°NE GELÄ°NDÄ°ÄžÄ°NDE 360 DERECE DÃ–NME */
.v-logo-nav:hover {
    transform: rotate(360deg) scale(1.2) !important; /* 360 Derece dÃ¶nme */
    filter: drop-shadow(0 0 15px rgba(252, 246, 186, 1));
}

.side-nav i, .side-nav a { 
    font-size: 24px; cursor: pointer; transition: 0.3s; text-decoration: none;
    background: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: inline-block;
}
.side-nav i:hover, .side-nav a:hover, .side-nav .active { 
    filter: drop-shadow(0 0 8px rgba(252, 246, 186, 0.5));
    transform: scale(1.1);
}

/* MODALLAR - DÄ°NAMÄ°K RENK */
.v-modal-content { 
    background-color: var(--modal-bg) !important; 
    border: 1px solid #d4af37 !important; 
    color: var(--ig-text) !important; 
    border-radius: 12px; 
}
.search-input-gold { 
    background-color: var(--input-bg) !important; 
    border: 1px solid var(--ig-border) !important; 
    color: var(--ig-text) !important; 
}

#avatarInput, #photoUploadInput { display: none; }
</style>

<aside class="side-nav">
    <div class="nav-top">
        <a href="{{ url_for('index') }}" title="Ana Sayfa"><i class="fa-solid fa-house"></i></a>
        <i class="fa-solid fa-magnifying-glass" onclick="openSearchModal()" title="KullanÄ±cÄ± Ara"></i>
        <a href="{{ url_for('profile', username=current_user.username) }}" title="Profilim"><i class="fa-solid fa-user-circle active"></i></a>
        
        <a href="{{ url_for('profile', username='VERZÄ°A') }}" class="v-logo-nav" title="Verzia Global">V</a>
    </div>
    <div class="nav-bottom">
        <a href="{{ url_for('settings') }}" title="Ayarlar"><i class="fa-solid fa-gear"></i></a>
        <a href="{{ url_for('logout') }}" title="Ã‡Ä±kÄ±ÅŸ"><i class="fa-solid fa-right-from-bracket"></i></a>
    </div>
</aside>

<div class="ig-container" style="padding-left: 90px;"> 
    <header class="ig-header">
        <div class="ig-avatar-area">
            <div class="avatar-wrapper" {% if can_edit %}onclick="document.getElementById('avatarInput').click()"{% endif %}>
                <img class="profile-avatar" id="avatarPreview" src="{{ server_profile.avatar }}" alt="avatar">
                {% if can_edit %}<input type="file" id="avatarInput" accept="image/*" onchange="previewImage(event)">{% endif %}
            </div>
        </div>
        <div class="ig-info-area">
            <div class="ig-user-row">
                <h2 class="profile-name">{{ server_profile.username }}</h2>
                {% if server_profile.is_vip %}<i class="fa-solid fa-circle-check gold-verify"></i>{% endif %}
                
                {% if can_edit %}
                <button class="btn-ig-edit" onclick="openEditBioModal()">Profili DÃ¼zenle</button>
                {% else %}
                <button class="btn-ig-follow" id="followBtn" onclick="toggleFollow('{{ server_profile.username }}')">
                    {% if is_following %}Takibi BÄ±rak{% else %}Takip Et{% endif %}
                </button>
                {% endif %}
            </div>
            <ul class="ig-stats">
                <li><b>{{ photos|length }}</b> gÃ¶nderi</li>
                <li onclick="{% if not server_profile.is_kurucu %}showUserList('followers'){% else %}void(0){% endif %}" style="{% if not server_profile.is_kurucu %}cursor:pointer{% endif %}">
                    <b id="followerCount">{{ server_profile.followers }}</b> takipÃ§i
                </li>
                <li onclick="showUserList('following')" style="cursor:pointer">
                    <b>{{ server_profile.following|default(0) }}</b> takip
                </li>
            </ul>
            <div class="ig-bio">
                <div id="profileBio">
                    <p class="mt-1" style="white-space: pre-wrap;">{{ server_profile.bio }}</p>
                </div>
            </div>
        </div>
    </header>

    <div class="d-flex justify-content-between align-items-center mb-4 px-2">
        <h5 class="verzia-gold-text mb-0" style="letter-spacing: 1px;">GÃ–NDERÄ°LER</h5>
        {% if can_edit and photos %}
        <button class="verzia-gold-btn btn-sm" onclick="triggerPhotoUpload()">
            <i class="fa-solid fa-plus"></i> Yeni Ekle
        </button>
        {% endif %}
    </div>

    <div class="ig-photo-grid">
        {% if photos %}
            {% for photo in photos %}
            <div class="grid-item">
                <img src="{{ url_for('uploaded_file', filename=photo.filename) }}" alt="{{ photo.title }}" onclick="openLightbox(this.src)">
            </div>
            {% endfor %}
        {% else %}
            <div class="no-posts">
                <div style="font-size: 50px; margin-bottom: 15px;">ðŸ“¸</div>
                <h3 class="verzia-gold-text">HenÃ¼z hiÃ§ gÃ¶nderi yok</h3>
                <p style="opacity: 0.7; margin-bottom: 20px;">Sen de hemen ÅŸimdi ilk fotoÄŸrafÄ±nÄ± paylaÅŸ!</p>
                {% if can_edit %}
                <button class="verzia-gold-btn" onclick="triggerPhotoUpload()">Hemen PaylaÅŸ</button>
                <form id="directUploadForm" action="{{ url_for('upload') }}" method="POST" enctype="multipart/form-data" style="display:none;">
                    <input type="file" name="photo" id="photoUploadInput" onchange="this.form.submit()">
                </form>
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="editBioModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content v-modal-content">
            <div class="v-modal-header border-bottom-0 p-3">
                <h5 class="modal-title verzia-gold-text">Biyografiyi DÃ¼zenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form action="{{ url_for('update_bio') }}" method="POST">
                    <textarea name="bio" class="form-control search-input-gold mb-3" rows="4" placeholder="Kendinizden bahsedin...">{{ server_profile.bio }}</textarea>
                    <button type="submit" class="verzia-gold-btn w-100">Kaydet</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="searchModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content v-modal-content">
            <div class="v-modal-header border-bottom-0 p-3">
                <h5 class="modal-title verzia-gold-text">KullanÄ±cÄ± Ara</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="text" id="userSearchInput" class="form-control search-input-gold" placeholder="KullanÄ±cÄ± adÄ± yazÄ±n..." oninput="searchUsers()">
                <div id="searchResults" class="mt-3" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
</div>

<script>
function triggerPhotoUpload() {
    const input = document.getElementById('photoUploadInput');
    if(input) input.click();
}

async function toggleFollow(username) {
    const btn = document.getElementById('followBtn');
    const isFollowing = btn.innerText.trim() === "Takibi BÄ±rak";
    const endpoint = isFollowing ? `/unfollow/${username}` : `/follow/${username}`;
    try {
        const response = await fetch(endpoint, { method: 'POST' });
        const data = await response.json();
        if (data.status === "success") {
            btn.innerText = isFollowing ? "Takip Et" : "Takibi BÄ±rak";
            const countElem = document.getElementById('followerCount');
            if (countElem && !countElem.innerText.includes('M')) countElem.innerText = data.followers;
        }
    } catch (e) { console.error(e); }
}

function openEditBioModal() { new bootstrap.Modal(document.getElementById('editBioModal')).show(); }

function openSearchModal() { 
    new bootstrap.Modal(document.getElementById('searchModal')).show();
    setTimeout(() => document.getElementById('userSearchInput').focus(), 500);
}

async function searchUsers() {
    const q = document.getElementById('userSearchInput').value;
    const resDiv = document.getElementById('searchResults');
    if (q.length < 2) { resDiv.innerHTML = ''; return; }
    try {
        const response = await fetch(`/search_users?q=${encodeURIComponent(q)}`);
        const users = await response.json();
        resDiv.innerHTML = users.map(u => `
            <a href="/profile/${u.username}" style="display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid var(--ig-border); text-decoration:none; color:inherit;">
                <img src="${u.avatar}" style="width:35px; height:35px; border-radius:50%; border:1px solid #d4af37; object-fit: cover;">
                <span>${u.username}</span>
            </a>
        `).join('');
    } catch (e) { console.error(e); }
}
</script>
{% endblock %}